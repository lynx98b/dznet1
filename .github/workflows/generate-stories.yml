name: Generate Stories Metadata

on:
  push:
    paths:
      - '**.html'
      - '**.jpg'
      - '**.png'
      - '**.jpeg'
  workflow_dispatch:

jobs:
  generate-metadata:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: List files (debug)
        run: |
          echo "ğŸ“ Contenu du repo:"
          ls -la
          echo "ğŸ“ Contenu racine:"
          ls -la *.js *.json || echo "Aucun fichier JS/JSON trouvÃ©"
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Generate stories metadata
        run: |
          if [ -f "generate-metadata.js" ]; then
            echo "âœ… Fichier generate-metadata.js trouvÃ©"
            node generate-metadata.js
          else
            echo "âŒ Fichier generate-metadata.js NON TROUVÃ‰"
            echo "ğŸ“ Liste des fichiers:"
            find . -name "*.js" -o -name "*.json" | head -20
            exit 1
          fi
          
      - name: Show results
        run: |
          if [ -f "stories-metadata.json" ]; then
            echo "âœ… Fichier gÃ©nÃ©rÃ© avec succÃ¨s"
            echo "ğŸ“Š RÃ©sumÃ©:"
            cat stories-metadata.json | jq '.scanSummary'
          else
            echo "âŒ stories-metadata.json non gÃ©nÃ©rÃ©"
            exit 1
          fi
          
      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add stories-metadata.json
          if git diff --staged --quiet; then
            echo "â© Aucun changement Ã  commiter"
          else
            git commit -m "Auto-update stories metadata"
            git push
          fi
