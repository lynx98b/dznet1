<!-- ==========================================================
 G√©n√©rateur de Prompt - Contenu HTML Enfant
 Version : v2.1 (Intelligence contextuelle + cache + auto-check)
========================================================== -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-CRRK6Z4D1X"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-CRRK6Z4D1X');
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>G√©n√©rateur Prompt Contenu Enfant - v2.1</title>

  <style>
    /* ===== VARIABLES & RESET ===== */
    :root{
      --primary:#4A90E2;--success:#27AE60;--warning:#F39C12;--danger:#E74C3C;--info:#3498DB;
      --bg-light:#F8F9FA;--text-dark:#2C3E50;--border:#DFE6E9;--shadow:rgba(0,0,0,0.1);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;padding:20px;color:var(--text-dark)
    }
    .container{max-width:1000px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
    header{background:linear-gradient(135deg,var(--primary) 0%,#357ABD 100%);color:#fff;padding:30px;text-align:center;position:relative}
    header h1{font-size:26px;margin-bottom:10px}
    header p{font-size:14px;opacity:.95}
    .version-badge{position:absolute;top:15px;right:15px;background:rgba(255,255,255,.2);padding:5px 15px;border-radius:20px;font-size:12px;font-weight:600}
    .help-btn{position:absolute;top:15px;left:15px;background:var(--warning);color:#fff;border:none;padding:10px 20px;border-radius:25px;cursor:pointer;font-weight:600;font-size:14px;transition:.3s;display:flex;align-items:center;gap:8px}
    .help-btn:hover{background:#E67E22;transform:scale(1.05)}
    
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.7);animation:fadeIn .3s;overflow-y:auto;padding:20px}
    .modal.active{display:flex;align-items:center;justify-content:center}
    .modal-content{background:#fff;padding:40px;border-radius:16px;max-width:700px;width:100%;max-height:85vh;overflow-y:auto;position:relative;animation:slideDown .4s}
    .modal-content.large{max-width:900px}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideDown{from{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}
    .modal-close{position:absolute;top:15px;right:15px;background:var(--danger);color:#fff;border:none;width:35px;height:35px;border-radius:50%;cursor:pointer;font-size:20px;font-weight:700;transition:.3s}
    .modal-close:hover{background:#C0392B;transform:rotate(90deg)}
    .modal-content h2{color:var(--primary);margin-bottom:20px;font-size:24px}
    .modal-content h3{color:var(--success);margin-top:25px;margin-bottom:15px;font-size:18px}
    
    .result-modal .modal-content{padding:0;overflow:hidden}
    .result-header{background:linear-gradient(135deg,var(--success) 0%,#229954 100%);color:#fff;padding:25px 40px;text-align:center}
    .result-header h2{color:#fff;margin:0 0 10px 0;font-size:26px}
    .result-body{padding:30px 40px;max-height:60vh;overflow-y:auto}
    #promptOutputModal{background:#F8F9FA;padding:20px;border-radius:8px;border:2px solid var(--border);font-family:'Courier New',monospace;font-size:13px;line-height:1.6;white-space:pre-wrap;word-wrap:break-word;max-height:400px;overflow-y:auto}
    .result-actions{padding:20px 40px 30px 40px;background:var(--bg-light);display:flex;gap:15px;flex-wrap:wrap}

    .form-wrapper{padding:40px}
    .metadata-section{background:#FFF9E6;padding:20px;border-radius:12px;margin-bottom:30px;border:2px solid var(--warning)}
    .metadata-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:15px}
    .section{margin-bottom:40px;padding-bottom:30px;border-bottom:2px solid var(--border)}
    .section:last-child{border-bottom:none}
    .section-title{font-size:20px;color:var(--primary);margin-bottom:20px;display:flex;align-items:center;gap:10px}
    .form-group{margin-bottom:20px;position:relative}
    label{display:block;font-weight:600;margin-bottom:8px;font-size:15px}
    label.required::after{content:" *";color:var(--danger)}

    .error-message{display:none;color:var(--danger);font-size:13px;font-weight:600;margin-top:5px;padding:8px 12px;background:#FADBD8;border-radius:4px;border-left:3px solid var(--danger)}
    .form-group.has-error .error-message{display:block;animation:shake .5s}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-10px)}75%{transform:translateX(10px)}}
    .form-group.has-error input,.form-group.has-error select,.form-group.has-error textarea{border-color:var(--danger);background:#FADBD8}

    input[type="text"],input[type="date"],select,textarea{width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;font-size:14px;transition:.3s;font-family:inherit}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(74,144,226,.1)}
    textarea{min-height:80px;resize:vertical}

    .checkbox-group,.radio-group{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:12px}
    .checkbox-item,.radio-item{display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg-light);border-radius:8px;cursor:pointer;transition:.3s;border:2px solid transparent}
    .checkbox-item:hover,.radio-item:hover{background:#E8F4F8;border-color:var(--primary)}
    .checkbox-item input:checked ~ span,.radio-item input:checked ~ span{font-weight:600;color:var(--primary)}
    input[type="checkbox"],input[type="radio"]{width:20px;height:20px;cursor:pointer;flex-shrink:0}

    /* ===== ACCORDION OBJECTIFS ===== */
    .search-box{margin-bottom:15px;position:relative}
    .search-box input{padding-left:40px}
    .search-box::before{content:"üîç";position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:18px;pointer-events:none}
    
    .goals-accordion{border:2px solid var(--border);border-radius:8px;max-height:400px;overflow-y:auto}
    .category{border-bottom:1px solid var(--border)}
    .category:last-child{border-bottom:none}
    .category-toggle{width:100%;padding:15px;background:#F8F9FA;border:none;text-align:left;cursor:pointer;font-weight:600;font-size:15px;display:flex;justify-content:space-between;align-items:center;transition:.3s}
    .category-toggle:hover{background:#E8F4F8}
    .category-toggle.active{background:var(--primary);color:#fff}
    .category-content{max-height:0;overflow:hidden;transition:max-height .3s ease;padding:0 15px}
    .category-content.expanded{max-height:1000px;padding:15px}
    .category-content .checkbox-group{grid-template-columns:1fr}
    .category-icon{transition:transform .3s}
    .category-toggle.active .category-icon{transform:rotate(180deg)}
    
    .selected-goals-preview{background:#E8F4F8;padding:15px;border-radius:8px;margin-top:15px;font-size:14px;border-left:4px solid var(--info)}
    .selected-goals-preview strong{color:var(--primary)}

    /* ===== MEDIA CHECK INTELLIGENT ===== */
    .media-check-section{background:#E8F4F8;padding:20px;border-radius:12px;margin:20px 0;border:2px solid var(--info);position:relative}
    .media-check-section.needs-check{background:#FFF3CD;border-color:var(--warning);animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(243,156,18,0.4)}50%{box-shadow:0 0 0 10px rgba(243,156,18,0)}}
    .media-check-banner{background:var(--warning);color:#fff;padding:12px;border-radius:8px;margin-bottom:15px;font-weight:600;text-align:center;display:none}
    .media-check-banner.visible{display:block}
    .media-check-btn{background:var(--info);color:#fff;padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:10px;transition:.3s;margin:0 auto}
    .media-check-btn:hover:not(:disabled){background:#2C81BA;transform:translateY(-2px)}
    .media-check-btn:disabled{opacity:.6;cursor:not-allowed}
    .media-check-btn.auto-trigger{animation:shake 1s ease-in-out}
    
    .media-results{margin-top:15px;padding:15px;background:#fff;border-radius:8px;display:none}
    .media-results.visible{display:block}
    .media-item{padding:8px 12px;margin:5px 0;border-radius:6px;display:flex;align-items:center;gap:10px;font-size:13px;font-family:monospace}
    .media-item.relevant{background:#D1F2EB;border-left:4px solid var(--success);font-weight:600}
    .media-item.suggested{background:#D4EDDA;border-left:4px solid var(--success)}
    .media-item.available{background:#E8F4F8;border-left:4px solid var(--info)}
    .media-item.missing{background:#F8D7DA;border-left:4px solid var(--danger)}
    
    .relevance-badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:700;margin-left:8px}
    .relevance-badge.high{background:var(--success);color:#fff}
    .relevance-badge.medium{background:var(--warning);color:#fff}
    .relevance-badge.low{background:var(--info);color:#fff}
    
    .media-stats{display:flex;gap:20px;margin-bottom:15px;padding:15px;background:var(--bg-light);border-radius:8px;flex-wrap:wrap}
    .media-stat{text-align:center;flex:1;min-width:100px}
    .media-stat-number{font-size:24px;font-weight:700;color:var(--primary)}
    .media-stat-label{font-size:12px;color:#7F8C8D;margin-top:5px}
    
    .intelligence-log{background:#FFF9E6;padding:12px;border-radius:8px;margin-top:15px;font-size:13px;border-left:4px solid var(--warning)}
    .intelligence-log h4{color:var(--warning);margin-bottom:8px;font-size:14px}
    .intelligence-log ul{margin-left:20px;line-height:1.8}

    .color-palette{display:flex;gap:10px;align-items:center;padding:10px;background:#fff;border-radius:8px;border:2px solid var(--border)}
    .color-palette input[type="radio"]{margin-right:10px}
    .color-swatch{width:30px;height:30px;border-radius:4px;border:2px solid #ddd}
    .palette-name{font-weight:600;flex:1}

    .button-group{display:flex;gap:15px;flex-wrap:wrap;margin-top:30px}
    button{padding:15px 30px;font-size:16px;font-weight:600;border:none;border-radius:8px;cursor:pointer;transition:.3s;display:flex;align-items:center;gap:10px;justify-content:center}
    button:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:var(--primary);color:#fff;flex:1;min-width:200px}
    .btn-primary:hover:not(:disabled){background:#357ABD;transform:translateY(-2px);box-shadow:0 5px 15px rgba(74,144,226,.4)}
    .btn-success{background:var(--success);color:#fff;flex:1;min-width:200px}
    .btn-success:hover:not(:disabled){background:#229954;transform:translateY(-2px);box-shadow:0 5px 15px rgba(39,174,96,.4)}
    .btn-secondary{background:var(--border);color:var(--text-dark)}
    .btn-secondary:hover{background:#BDC3C7}
    .spinner{display:none;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    button.loading .spinner{display:block}
    button.loading span:not(.spinner){display:none}
    .helper-text{font-size:13px;color:#7F8C8D;margin-top:5px;font-style:italic}
    .info-banner{background:#E3F2FD;border-left:4px solid var(--info);padding:15px;margin:20px 0;border-radius:4px;font-size:14px}
    .feature-badge{display:inline-block;background:var(--success);color:#fff;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600;margin-left:8px}

    .format-toggle{display:flex;gap:10px;margin-bottom:20px;background:var(--bg-light);padding:15px;border-radius:8px}
    .format-option{flex:1;text-align:center;padding:10px;border-radius:6px;cursor:pointer;transition:.3s;border:2px solid transparent}
    .format-option.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .format-option:not(.active):hover{background:#E8F4F8;border-color:var(--primary)}
    .json-preview{background:#2C3E50;color:#ECF0F1;padding:15px;border-radius:8px;font-family:'Courier New',monospace;font-size:12px;max-height:200px;overflow-y:auto;margin-top:10px;display:none}
    .json-key{color:#3498DB}.json-string{color:#27AE60}.json-number{color:#E74C3C}.json-boolean{color:#9B59B6}

    .preset-hint{display:inline-block;margin-left:8px;font-size:12px;color:#2d6cdf;background:#E8F0FE;border:1px solid #BFD1FF;border-radius:999px;padding:2px 8px}
    .tiny{font-size:12px;opacity:.8}

    .form-group.disabled-field {
        opacity: 0.6;
        pointer-events: none;
        position: relative;
    }
    .disabled-tooltip {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(149, 165, 166, 0.05);
        border-radius: 8px;
        border: 2px dashed #bdc3c7;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: help;
        z-index: 1;
    }
    .disabled-tooltip-text {
        display: none;
        position: absolute;
        top: -60px;
        left: 50%;
        transform: translateX(-50%);
        background: #34495e;
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 13px;
        white-space: nowrap;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10;
    }
    .disabled-tooltip-text::after {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid #34495e;
    }
    .disabled-tooltip:hover .disabled-tooltip-text {
        display: block;
    }

    @media (max-width:768px){
      body{padding:10px}
      .form-wrapper{padding:20px}
      header h1{font-size:20px}
      .help-btn,.version-badge{position:static;margin:10px auto}
      header{padding:20px}
      .button-group{flex-direction:column}
      .btn-primary,.btn-success{width:100%}
      .checkbox-group,.radio-group{grid-template-columns:1fr}
      .modal-content{padding:25px;margin:20px;max-height:90vh}
      .result-header,.result-body,.result-actions{padding:20px}
      .metadata-grid{grid-template-columns:1fr}
      .category-content .checkbox-group{grid-template-columns:1fr}
      .media-stats{flex-direction:column;gap:10px}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <header>
      <button class="help-btn" onclick="openHelpModal()">
        <span>‚ùì</span><span>Guide</span>
      </button>
      <span class="version-badge">v2.1</span>
      <h1>üé® G√©n√©rateur de Prompt - Contenu HTML Enfant</h1>
      <p>Cr√©ez des exp√©riences √©ducatives interactives s√©curis√©es</p>
      <p class="tiny">‚úÖ 80 objectifs | üß† IA contextuelle | üíæ Cache 1h</p>
    </header>

    <!-- MODAL AIDE -->
    <div id="helpModal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closeHelpModal()">√ó</button>
        <h2>üìò Guide rapide v2.1</h2>
        <div class="info-banner">
          <strong>üß† Intelligence Contextuelle :</strong>
          <ul style="margin:10px 0 0 20px;line-height:1.8">
            <li>‚ú® Analyse automatique : th√®me + type + objectifs</li>
            <li>üéØ Filtre intelligent des m√©dias pertinents</li>
            <li>üíæ Cache 1h pour √©viter appels API r√©p√©t√©s</li>
            <li>‚ö° Suggestion auto si m√©dias non v√©rifi√©s</li>
          </ul>
        </div>
        <h3>Exemple intelligent</h3>
        <p><strong>Th√®me :</strong> "Les capitales de l'Alg√©rie"</p>
        <p><strong>‚Üí IA d√©tecte :</strong> ALGER, ORAN, CONSTANTINE, ANNABA...</p>
        <p><strong>‚Üí Filtre :</strong> Ne montre QUE les m√©dias pertinents</p>
        <button class="btn-primary" onclick="closeHelpModal()" style="margin-top: 16px; width: 100%;">OK</button>
      </div>
    </div>

    <!-- MODAL R√âSULTAT (identique v2.0) -->
    <div id="resultModal" class="modal result-modal">
      <div class="modal-content large">
        <button class="modal-close" onclick="closeResultModal()">√ó</button>
        <div class="result-header">
          <h2>üéâ Prompt G√©n√©r√©</h2>
          <p class="tiny" style="margin:0;">Copiez ou exportez en .txt</p>
        </div>
        <div class="result-body">
          <div id="promptOutputModal"></div>
        </div>
        <div class="result-actions">
          <button id="copyBtnModal" class="btn-success"><span class="spinner"></span><span>üìã Copier</span></button>
          <button id="downloadBtnModal" class="btn-primary"><span>üíæ Exporter (.txt)</span></button>
          <button onclick="closeResultModal()" class="btn-secondary">‚úñÔ∏è Fermer</button>
        </div>
      </div>
    </div>

    <!-- FORMULAIRE -->
    <div class="form-wrapper">
      <div class="format-toggle">
        <div class="format-option active" data-format="json">üöÄ Format JSON (Recommand√©)</div>
        <div class="format-option" data-format="text">üìù Format Texte</div>
      </div>
      <div id="jsonPreview" class="json-preview"></div>

      <form id="promptForm">
        <!-- M√âTADONN√âES -->
        <div class="metadata-section">
          <h3 style="color:var(--warning);margin-bottom:15px;">üìù Informations du Projet</h3>
          
          <div class="form-group" style="margin-bottom:20px;background:#E8F4F8;padding:15px;border-radius:8px;border:2px solid var(--info);">
            <label class="checkbox-item" style="margin:0;cursor:pointer;background:transparent;">
              <input type="checkbox" id="testMode" name="testMode" checked style="width:24px;height:24px;">
              <span style="font-weight:700;color:var(--info);flex:1;">
                üß™ Version test (chemins locaux)
                <span class="helper-text" style="display:block;margin-top:5px;font-weight:400;font-style:italic;">
                  Coch√© : m√©dias /images/ et /audio/. D√©coch√© : CDN distants.
                </span>
              </span>
            </label>
          </div>

          <div class="metadata-grid">
            <div class="form-group" style="margin-bottom:0;">
              <label for="creatorName" class="required">Votre nom</label>
              <input type="text" id="creatorName" placeholder="Ex: Marie Dupont" required maxlength="100">
              <div class="error-message">‚ùå Champ obligatoire</div>
            </div>
            <div class="form-group" style="margin-bottom:0;">
              <label for="projectVersion">Version</label>
              <input type="text" id="projectVersion" value="v2.1" placeholder="v2.1">
            </div>
            <div class="form-group" style="margin-bottom:0;">
              <label>Date</label>
              <input type="text" id="creationDate" readonly style="background:#f0f0f0;">
            </div>
          </div>
        </div>

        <!-- 1Ô∏è‚É£ PUBLIC CIBLE (version r√©duite) -->
        <div class="section">
          <h2 class="section-title">1Ô∏è‚É£ Public Cible</h2>
          <div class="form-group" id="ageGroup">
            <label class="required">Tranches d'√¢ge</label>
            <div class="checkbox-group">
              <label class="checkbox-item"><input type="checkbox" name="ageRange" value="3-4 ans"><span>3-4 ans</span></label>
              <label class="checkbox-item"><input type="checkbox" name="ageRange" value="5-6 ans"><span>5-6 ans</span></label>
              <label class="checkbox-item"><input type="checkbox" name="ageRange" value="7-8 ans"><span>7-8 ans</span></label>
              <label class="checkbox-item"><input type="checkbox" name="ageRange" value="9-10 ans"><span>9-10 ans</span></label>
            </div>
            <div class="error-message">‚ùå S√©lectionnez au moins une tranche</div>
          </div>

          <div class="form-group" id="readingGroup">
            <label class="required">Niveau de lecture</label>
            <div class="radio-group">
              <label class="radio-item"><input type="radio" name="readingLevel" value="Pr√©-lecteur" required><span>Pr√©-lecteur</span></label>
              <label class="radio-item"><input type="radio" name="readingLevel" value="Lecteur d√©butant"><span>D√©butant</span></label>
              <label class="radio-item"><input type="radio" name="readingLevel" value="Lecteur autonome"><span>Autonome</span></label>
            </div>
            <div class="error-message">‚ùå S√©lectionnez un niveau</div>
          </div>
        </div>

        <!-- 2Ô∏è‚É£ TYPE DE CONTENU -->
        <div class="section">
          <h2 class="section-title">2Ô∏è‚É£ Type de contenu</h2>
          <div class="form-group" id="contentTypeGroup">
            <label class="required" for="contentType">Choisir un type</label>
            <select id="contentType" required>
              <option value="">‚Äî S√©lectionner ‚Äî</option>
              <option value="histoire">Histoire</option>
              <option value="jeu_educatif">Jeu √©ducatif</option>
              <option value="quiz">Quiz interactif</option>
              <option value="coloriage">Coloriage</option>
              <option value="encyclopedie">Encyclop√©die</option>
            </select>
            <div class="error-message">‚ùå Choisissez un type</div>
          </div>
          <div class="button-group" style="margin-top:5px;">
            <button type="button" id="applyPresetBtn" class="btn-success">‚ö° Appliquer preset</button>
            <button type="button" id="clearSelectionsBtn" class="btn-secondary">üßπ Effacer</button>
            <span id="presetHint" class="preset-hint"></span>
          </div>
        </div>

        <!-- 3Ô∏è‚É£ LANGUES -->
        <div class="section">
          <h2 class="section-title">3Ô∏è‚É£ Langues</h2>
          <div class="form-group">
            <div class="checkbox-group">
              <label class="checkbox-item"><input type="checkbox" name="languages" value="Fran√ßais" checked><span>üá´üá∑ Fran√ßais</span></label>
              <label class="checkbox-item"><input type="checkbox" name="languages" value="Arabe"><span>üá©üáø ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</span></label>
              <label class="checkbox-item"><input type="checkbox" name="languages" value="Anglais"><span>üá¨üáß English</span></label>
            </div>
          </div>
        </div>

        <!-- 4Ô∏è‚É£ TH√àME & V√âRIFICATION INTELLIGENTE -->
        <div class="section">
          <h2 class="section-title">4Ô∏è‚É£ Th√®me & M√©dias <span class="feature-badge">IA v2.1</span></h2>
          <div class="form-group" id="themeGroup">
            <label for="theme" class="required">Sujet principal</label>
            <input type="text" id="theme" placeholder="Ex: Les capitales de l'Alg√©rie" required>
            <div class="error-message">‚ùå D√©crivez le sujet</div>
            <span class="helper-text">L'IA analysera ce th√®me pour sugg√©rer m√©dias pertinents</span>
          </div>

          <!-- V√âRIFICATION INTELLIGENTE M√âDIAS -->
          <div class="media-check-section" id="mediaCheckSection">
            <div class="media-check-banner" id="mediaCheckBanner">
              ‚ö†Ô∏è Cliquez sur "Analyser m√©dias" pour optimiser votre contenu
            </div>
            
            <h3 style="color:var(--info);margin-bottom:15px;">üß† Analyse Intelligente des M√©dias</h3>
            <p style="margin-bottom:15px;font-size:14px;color:#7F8C8D;">
              L'IA analyse votre th√®me, type de contenu et objectifs pour sugg√©rer les m√©dias les plus pertinents.
            </p>
            
            <button type="button" id="checkMediaBtn" class="media-check-btn">
              <span class="spinner"></span>
              <span>üîç Analyser m√©dias disponibles</span>
            </button>
            
            <div id="mediaResults" class="media-results">
              <div class="media-stats">
                <div class="media-stat">
                  <div class="media-stat-number" id="totalMedia">0</div>
                  <div class="media-stat-label">Total</div>
                </div>
                <div class="media-stat">
                  <div class="media-stat-number" id="relevantMedia" style="color:var(--success)">0</div>
                  <div class="media-stat-label">Pertinents</div>
                </div>
                <div class="media-stat">
                  <div class="media-stat-number" id="suggestedMedia" style="color:var(--warning)">0</div>
                  <div class="media-stat-label">Sugg√©r√©s</div>
                </div>
                <div class="media-stat">
                  <div class="media-stat-number" id="otherMedia" style="color:var(--info)">0</div>
                  <div class="media-stat-label">Autres</div>
                </div>
              </div>
              
              <div class="intelligence-log" id="intelligenceLog"></div>
              <div id="mediaList"></div>
            </div>
          </div>

          <!-- OBJECTIFS (version condens√©e) -->
          <div class="form-group" id="goalsGroup">
            <label class="required">Objectifs p√©dagogiques</label>
            <div class="search-box">
              <input type="text" id="searchGoals" placeholder="Rechercher...">
            </div>
            
            <div class="goals-accordion" id="goalsAccordion">
              <div class="category">
                <button type="button" class="category-toggle">
                  <span>üìê Math√©matiques <span class="count">(0/4)</span></span>
                  <span class="category-icon">‚ñº</span>
                </button>
                <div class="category-content">
                  <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" name="pedGoals" value="Chiffres 0-10"><span>Chiffres 0-10</span></label>
                    <label class="checkbox-item"><input type="checkbox" name="pedGoals" value="Comptage 1-10"><span>Comptage 1-10</span></label>
                    <label class="checkbox-item"><input type="checkbox" name="pedGoals" value="Addition simple"><span>Addition simple</span></label>
                    <label class="checkbox-item"><input type="checkbox" name="pedGoals" value="Suites logiques"><span>Suites logiques</span></label>
                  </div>
                </div>
              </div>
              
              <div class="category">
                <button type="button" class="category-toggle">
                  <span>üî§ Langues <span class="count">(0/3)</span></span>
                  <span class="category-icon">‚ñº</span>
                </button>
                <div class="category-content">
                  <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" name="pedGoals" value="Alphabet"><span>Alphabet</span></label>
                    <label class="checkbox-item"><input type="checkbox" name="pedGoals" value="Lecture mots"><span>Lecture mots</span></label>
                    <label class="checkbox-item"><input type="checkbox" name="pedGoals" value="Vocabulaire"><span>Vocabulaire</span></label>
                  </div>
                </div>
              </div>

              <div class="category">
                <button type="button" class="category-toggle">
                  <span>üé® Couleurs <span class="count">(0/2)</span></span>
                  <span class="category-icon">‚ñº</span>
                </button>
                <div class="category-content">
                  <div class="checkbox-group">
                    <label class="checkbox-item"><input type="checkbox" name="pedGoals" value="Couleurs primaires"><span>Couleurs primaires</span></label>
                    <label class="checkbox-item"><input type="checkbox" name="pedGoals" value="Formes 2D"><span>Formes 2D</span></label>
                  </div>
                </div>
              </div>
            </div>

            <div class="selected-goals-preview">
              <strong>S√©lectionn√©s :</strong> <span id="selectedCount">0</span> objectifs
            </div>
            <div class="error-message">‚ùå Au moins un objectif</div>
          </div>

          <div class="form-group">
            <label for="customGoals">Autres objectifs</label>
            <textarea id="customGoals" placeholder="Un par ligne"></textarea>
          </div>
        </div>

        <!-- BOUTONS -->
        <div class="button-group">
          <button type="submit" id="submitBtn" class="btn-primary"><span class="spinner"></span><span>üöÄ G√©n√©rer Prompt</span></button>
          <button type="reset" class="btn-secondary">üîÑ R√©initialiser</button>
        </div>
      </form>
    </div>
  </div>

<!--
ATTENTION CRITIQUE : NE PAS MODIFIER LES COMMENTAIRES CI-DESSOUS
Ces commentaires sont n√©cessaires pour la compatibilit√© GitHub API
-->
  <script>
    // ===== VERSION & CONFIG =====
    const VERSION = "v2.1";
    const STORAGE_KEY_NAME = 'prompt_generator_creator_name';
    const STORAGE_KEY_CACHE = 'github_media_cache';
    const CACHE_DURATION = 3600000; // 1 heure en ms
    const GITHUB_REPO = 'lynx98b/dznet1';
    const GITHUB_FOLDERS = ['img', 'sounds', 'icons', 'fonts'];
    
    let currentFormat = 'json';
    let testModeEnabled = true;
    let githubMediaCache = null;
    let intelligenceContext = {
      theme: '',
      contentType: '',
      goals: [],
      keywords: []
    };

    // ===== INTELLIGENCE CONTEXTUELLE =====
    const CONTEXT_KEYWORDS = {
      algerie: ['ALGER', 'ORAN', 'CONSTANTINE', 'ANNABA', 'TLEMCEN', 'SETIF', 'BATNA', 'BLIDA', 'BEJAIA', 'TIZI', 'GHARDAIA'],
      france: ['PARIS', 'LYON', 'MARSEILLE', 'TOULOUSE', 'NICE', 'NANTES', 'BORDEAUX'],
      animaux: ['chat', 'chien', 'lion', 'elephant', 'oiseau', 'poisson', 'lapin', 'vache', 'cheval'],
      couleurs: ['rouge', 'bleu', 'jaune', 'vert', 'orange', 'violet', 'rose', 'noir', 'blanc'],
      formes: ['carre', 'cercle', 'triangle', 'rectangle', 'etoile', 'losange'],
      chiffres: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
      lettres: ['A', 'B', 'C', 'D', 'E', 'F', 'alphabet']
    };

    const TYPE_MEDIA_PRIORITY = {
      histoire: ['img', 'sounds'],
      jeu_educatif: ['img', 'icons', 'sounds'],
      quiz: ['img', 'icons'],
      coloriage: ['img'],
      encyclopedie: ['img', 'sounds']
    };

    // ===== FONCTIONS INTELLIGENCE =====
    function extractKeywords(text) {
      const normalized = text.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9\s]/g, ' ');
      
      const words = normalized.split(/\s+/).filter(w => w.length > 3);
      const keywords = new Set();

      // D√©tection contexte
      for (const [context, contextWords] of Object.entries(CONTEXT_KEYWORDS)) {
        if (words.some(w => context.includes(w) || w.includes(context))) {
          contextWords.forEach(kw => keywords.add(kw.toLowerCase()));
        }
      }

      // Mots significatifs
      words.forEach(w => {
        if (w.length > 4) keywords.add(w);
      });

      return Array.from(keywords);
    }

    function calculateRelevance(filename, context) {
      const filenameNorm = filename.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      
      let score = 0;
      let reasons = [];

      // Correspondance exacte th√®me
      context.keywords.forEach(kw => {
        if (filenameNorm.includes(kw.toLowerCase())) {
          score += 10;
          reasons.push(`Th√®me: ${kw}`);
        }
      });

      // Correspondance type de contenu
      const extension = filename.split('.').pop().toLowerCase();
      const folder = getFolderFromFilename(filename);
      const priority = TYPE_MEDIA_PRIORITY[context.contentType] || [];
      
      if (priority.includes(folder)) {
        score += 5;
        reasons.push(`Type: ${context.contentType}`);
      }

      // Correspondance objectifs
      context.goals.forEach(goal => {
        const goalWords = goal.toLowerCase().split(/\s+/);
        goalWords.forEach(gw => {
          if (gw.length > 3 && filenameNorm.includes(gw)) {
            score += 3;
            reasons.push(`Objectif: ${gw}`);
          }
        });
      });

      return { score, reasons, level: score >= 10 ? 'high' : score >= 5 ? 'medium' : 'low' };
    }

    function getFolderFromFilename(filename) {
      // Logique pour d√©terminer le dossier (simplifi√©)
      const ext = filename.split('.').pop().toLowerCase();
      if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) return 'img';
      if (['mp3', 'wav', 'ogg'].includes(ext)) return 'sounds';
      if (['svg', 'ico'].includes(ext)) return 'icons';
      if (['ttf', 'woff', 'woff2'].includes(ext)) return 'fonts';
      return 'unknown';
    }

    // ===== CACHE MANAGEMENT =====
    function getCachedMedia() {
      try {
        const cached = localStorage.getItem(STORAGE_KEY_CACHE);
        if (!cached) return null;
        
        const data = JSON.parse(cached);
        const age = Date.now() - data.timestamp;
        
        if (age > CACHE_DURATION) {
          localStorage.removeItem(STORAGE_KEY_CACHE);
          return null;
        }
        
        console.log(`üì¶ Cache valide (${Math.round(age/60000)}min)`);
        return data.media;
      } catch (e) {
        return null;
      }
    }

    function setCachedMedia(media) {
      try {
        localStorage.setItem(STORAGE_KEY_CACHE, JSON.stringify({
          media: media,
          timestamp: Date.now()
        }));
        console.log('üíæ Cache sauvegard√©');
      } catch (e) {
        console.warn('Cache storage failed');
      }
    }

    // ===== GITHUB API =====
/*
NE PAS SUPPRIMER CES COMMENTAIRES - COMPATIBILIT√â GITHUB
*/
    async function fetchGitHubMedia() {
      const btn = document.getElementById('checkMediaBtn');
      btn.classList.add('loading');
      btn.disabled = true;

      // V√©rifier cache
      const cached = getCachedMedia();
      if (cached) {
        githubMediaCache = cached;
        processIntelligentFilter();
        btn.classList.remove('loading');
        btn.disabled = false;
        return;
      }

      const allMedia = {
        img: [],
        sounds: [],
        icons: [],
        fonts: []
      };

      try {
        for (const folder of GITHUB_FOLDERS) {
/*
URL API GITHUB - NE PAS MODIFIER
*/
          const response = await fetch(
            `https://api.github.com/repos/${GITHUB_REPO}/contents/intranet/${folder}`,
            {
              headers: {
/*
HEADER GITHUB API v3 - REQUIS
*/
                'Accept': 'application/vnd.github.v3+json'
              }
            }
          );

          if (response.ok) {
            const data = await response.json();
            allMedia[folder] = data.filter(item => item.type === 'file').map(item => item.name);
          }
        }

        githubMediaCache = allMedia;
        setCachedMedia(allMedia);
        processIntelligentFilter();
        
      } catch (error) {
        console.error('Erreur API GitHub:', error);
        alert('‚ùå Erreur lors de la r√©cup√©ration des m√©dias GitHub');
      } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
      }
    }
/*
FIN SECTION CRITIQUE GITHUB
*/

    function processIntelligentFilter() {
      if (!githubMediaCache) return;

      // Construire contexte
      intelligenceContext = {
        theme: document.getElementById('theme').value.trim(),
        contentType: document.getElementById('contentType').value,
        goals: Array.from(document.querySelectorAll('input[name="pedGoals"]:checked')).map(cb => cb.value),
        keywords: extractKeywords(document.getElementById('theme').value + ' ' + 
                  Array.from(document.querySelectorAll('input[name="pedGoals"]:checked')).map(cb => cb.value).join(' '))
      };

      // Analyser et trier m√©dias
      const allFiles = [];
      for (const [folder, files] of Object.entries(githubMediaCache)) {
        files.forEach(file => {
          const relevance = calculateRelevance(file, intelligenceContext);
          allFiles.push({
            folder,
            name: file,
            relevance: relevance.score,
            level: relevance.level,
            reasons: relevance.reasons
          });
        });
      }

      // Trier par pertinence
      allFiles.sort((a, b) => b.relevance - a.relevance);

      displayIntelligentResults(allFiles);
    }

    function displayIntelligentResults(files) {
      const resultsDiv = document.getElementById('mediaResults');
      const listDiv = document.getElementById('mediaList');
      const logDiv = document.getElementById('intelligenceLog');
      
      const relevant = files.filter(f => f.level === 'high');
      const suggested = files.filter(f => f.level === 'medium');
      const others = files.filter(f => f.level === 'low');
      
      document.getElementById('totalMedia').textContent = files.length;
      document.getElementById('relevantMedia').textContent = relevant.length;
      document.getElementById('suggestedMedia').textContent = suggested.length;
      document.getElementById('otherMedia').textContent = others.length;

      // Log intelligence
      let logHtml = '<h4>üß† Analyse contextuelle :</h4><ul>';
      logHtml += `<li><strong>Th√®me :</strong> ${intelligenceContext.theme || 'Non d√©fini'}</li>`;
      logHtml += `<li><strong>Type :</strong> ${intelligenceContext.contentType || 'Non d√©fini'}</li>`;
      logHtml += `<li><strong>Mots-cl√©s d√©tect√©s :</strong> ${intelligenceContext.keywords.slice(0, 5).join(', ') || 'Aucun'}</li>`;
      logHtml += `<li><strong>Objectifs :</strong> ${intelligenceContext.goals.length} s√©lectionn√©s</li>`;
      logHtml += '</ul>';
      logDiv.innerHTML = logHtml;

      // Liste m√©dias
      let html = '';
      
      if (relevant.length > 0) {
        html += '<h4 style="margin:15px 0 10px 0;color:var(--success);">üéØ M√©dias tr√®s pertinents :</h4>';
        relevant.slice(0, 10).forEach(file => {
          html += `<div class="media-item relevant">
            ‚úÖ ${file.folder}/${file.name}
            <span class="relevance-badge high">PERTINENT</span>
            <span style="font-size:11px;color:#7F8C8D;margin-left:8px;">${file.reasons.slice(0, 2).join(', ')}</span>
          </div>`;
        });
        if (relevant.length > 10) {
          html += `<div style="color:#7F8C8D;font-size:12px;margin:5px 0;">... et ${relevant.length - 10} autres</div>`;
        }
      }

      if (suggested.length > 0) {
        html += '<h4 style="margin:15px 0 10px 0;color:var(--warning);">üí° M√©dias sugg√©r√©s :</h4>';
        suggested.slice(0, 5).forEach(file => {
          html += `<div class="media-item suggested">
            ‚úì ${file.folder}/${file.name}
            <span class="relevance-badge medium">SUGG√âR√â</span>
          </div>`;
        });
      }

      if (others.length > 0 && others.length < 50) {
        html += '<h4 style="margin:15px 0 10px 0;color:var(--info);">üìÅ Autres disponibles :</h4>';
        others.slice(0, 5).forEach(file => {
          html += `<div class="media-item available">‚óã ${file.folder}/${file.name}</div>`;
        });
        if (others.length > 5) {
          html += `<div style="color:#7F8C8D;font-size:12px;margin:5px 0;">... et ${others.length - 5} autres</div>`;
        }
      }

      listDiv.innerHTML = html;
      resultsDiv.classList.add('visible');
      
      // Masquer le banner
      document.getElementById('mediaCheckBanner').classList.remove('visible');
      document.getElementById('mediaCheckSection').classList.remove('needs-check');
    }

    // ===== INITIALISATION =====
    window.addEventListener('DOMContentLoaded', function(){
      document.getElementById('creationDate').value = new Date().toLocaleDateString('fr-FR',{year:'numeric',month:'long',day:'numeric'});
      const savedName = localStorage.getItem(STORAGE_KEY_NAME);
      if(savedName){ document.getElementById('creatorName').value = savedName; }
      
      initFormatSelector();
      attachLivePreview();
      initGoalsAccordion();
      initGoalsSearch();
      updateJsonPreview();
      
      document.getElementById('testMode').addEventListener('change', function(){
        testModeEnabled = this.checked;
        updateJsonPreview();
      });

      document.getElementById('checkMediaBtn').addEventListener('click', fetchGitHubMedia);
      
      // Auto-suggestion si th√®me rempli
      document.getElementById('theme').addEventListener('blur', function(){
        if (this.value.trim() && !githubMediaCache) {
          setTimeout(() => {
            document.getElementById('mediaCheckBanner').classList.add('visible');
            document.getElementById('mediaCheckSection').classList.add('needs-check');
          }, 500);
        }
      });

      document.getElementById('applyPresetBtn').addEventListener('click', applyPreset);
      document.getElementById('clearSelectionsBtn').addEventListener('click', clearSelections);
    });

    function initFormatSelector(){
      const options = document.querySelectorAll('.format-option');
      options.forEach(opt=>{
        opt.addEventListener('click',function(){
          options.forEach(o=>o.classList.remove('active'));
          this.classList.add('active');
          currentFormat = this.dataset.format;
          const box = document.getElementById('jsonPreview');
          if(currentFormat==='json'){ box.style.display='block'; updateJsonPreview(); }
          else{ box.style.display='none'; }
        });
      });
    }

    function attachLivePreview(){
      document.querySelectorAll('input,select,textarea').forEach(el=>{
        el.addEventListener('change',updateJsonPreview);
        el.addEventListener('input',updateJsonPreview);
      });
      document.getElementById('creatorName').addEventListener('blur',function(){
        const name = this.value.trim(); 
        if(name && name.length <= 100){ 
          localStorage.setItem(STORAGE_KEY_NAME,name); 
        }
      });
    }

    function initGoalsAccordion(){
      const toggles = document.querySelectorAll('.category-toggle');
      toggles.forEach(toggle => {
        toggle.addEventListener('click', function(){
          const content = this.nextElementSibling;
          const wasActive = this.classList.contains('active');
          
          toggles.forEach(t => {
            t.classList.remove('active');
            t.nextElementSibling.classList.remove('expanded');
          });
          
          if(!wasActive){
            this.classList.add('active');
            content.classList.add('expanded');
          }
        });
      });

      document.querySelectorAll('input[name="pedGoals"]').forEach(cb => {
        cb.addEventListener('change', updateGoalsCount);
      });
      updateGoalsCount();
    }

    function updateGoalsCount(){
      let totalSelected = 0;
      document.querySelectorAll('.category').forEach(cat => {
        const checkboxes = cat.querySelectorAll('input[name="pedGoals"]');
        const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
        const total = checkboxes.length;
        const counter = cat.querySelector('.count');
        if(counter){ counter.textContent = `(${checked}/${total})`; }
        totalSelected += checked;
      });
      document.getElementById('selectedCount').textContent = totalSelected;
      updateJsonPreview();
    }

    function initGoalsSearch(){
      const searchInput = document.getElementById('searchGoals');
      searchInput.addEventListener('input', function(){
        const query = this.value.toLowerCase().trim();
        const categories = document.querySelectorAll('.category');
        
        if(!query){
          categories.forEach(cat => {
            cat.style.display = 'block';
            cat.querySelectorAll('.checkbox-item').forEach(item => {
              item.style.display = 'flex';
            });
          });
          return;
        }

        categories.forEach(cat => {
          const items = cat.querySelectorAll('.checkbox-item');
          let hasVisible = false;
          
          items.forEach(item => {
            const text = item.textContent.toLowerCase();
            if(text.includes(query)){
              item.style.display = 'flex';
              hasVisible = true;
            } else {
              item.style.display = 'none';
            }
          });

          cat.style.display = hasVisible ? 'block' : 'none';
        });
      });
    }

    function applyPreset(){
      const type = document.getElementById('contentType').value;
      if(!type){ 
        document.getElementById('presetHint').textContent='S√©lectionnez un type'; 
        return; 
      }
      document.getElementById('presetHint').textContent = '‚úÖ Preset appliqu√©';
    }

    function clearSelections(){
      document.querySelectorAll('input[name="pedGoals"]').forEach(i=>i.checked=false);
      updateGoalsCount();
      document.getElementById('presetHint').textContent = '';
    }

    function syntaxHighlight(json){
      json = json.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (m){
        let cls = 'json-number';
        if(/^"/.test(m)){ cls = (/:$/.test(m)) ? 'json-key' : 'json-string'; }
        else if(/true|false/.test(m)){ cls = 'json-boolean'; }
        return '<span class="'+cls+'">'+m+'</span>';
      });
    }

    function getCheckedValues(name){
      return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb=>cb.value);
    }

    function updateJsonPreview(){
      if(currentFormat!=='json') return;
      const data = {
        metadata: { 
          creator: document.getElementById('creatorName').value.trim() || "Nom",
          version: document.getElementById('projectVersion').value,
          testMode: document.getElementById('testMode').checked
        },
        content: {
          theme: document.getElementById('theme').value.trim() || "Th√®me",
          type: document.getElementById('contentType').value || "Type",
          goals: getCheckedValues('pedGoals')
        }
      };
      document.getElementById('jsonPreview').innerHTML = syntaxHighlight(JSON.stringify(data,null,2));
    }

    function openHelpModal(){ document.getElementById('helpModal').classList.add('active'); }
    function closeHelpModal(){ document.getElementById('helpModal').classList.remove('active'); }
    function openResultModal(){ document.getElementById('resultModal').classList.add('active'); }
    function closeResultModal(){ document.getElementById('resultModal').classList.remove('active'); }

    function clearErrors(){ document.querySelectorAll('.form-group.has-error').forEach(g=>g.classList.remove('has-error')); }
    function showError(groupId){
      const g = document.getElementById(groupId); 
      if(g) g.classList.add('has-error');
    }

    function validateForm(){
      clearErrors(); 
      let ok = true;
      
      if(!document.getElementById('creatorName').value.trim()){ 
        showError('creatorName'); ok=false; 
      }
      if(!document.getElementById('contentType').value){ 
        showError('contentTypeGroup'); ok=false; 
      }
      if(getCheckedValues('ageRange').length===0){ 
        showError('ageGroup'); ok=false; 
      }
      if(!document.querySelector('input[name="readingLevel"]:checked')){ 
        showError('readingGroup'); ok=false; 
      }
      if(!document.getElementById('theme').value.trim()){ 
        showError('themeGroup'); ok=false; 
      }
      
      return ok;
    }

    document.getElementById('promptForm').addEventListener('submit',function(e){
      e.preventDefault();
      
      // V√©rifier si m√©dias analys√©s
      if (!githubMediaCache && document.getElementById('theme').value.trim()) {
        if (confirm('‚ö†Ô∏è M√©dias non v√©rifi√©s. Voulez-vous analyser maintenant pour optimiser votre contenu ?')) {
          fetchGitHubMedia();
          return;
        }
      }
      
      if(!validateForm()) return;
      
      const btn = document.getElementById('submitBtn');
      btn.classList.add('loading'); 
      btn.disabled = true;
      setTimeout(()=>{ 
        generatePrompt(); 
        btn.classList.remove('loading'); 
        btn.disabled=false; 
      }, 500);
    });

    document.getElementById('promptForm').addEventListener('reset', function(){
      setTimeout(()=>{
        clearErrors();
        document.getElementById('testMode').checked = true;
        githubMediaCache = null;
        intelligenceContext = { theme: '', contentType: '', goals: [], keywords: [] };
        document.getElementById('mediaResults').classList.remove('visible');
        document.getElementById('mediaCheckBanner').classList.remove('visible');
        document.getElementById('mediaCheckSection').classList.remove('needs-check');
        updateGoalsCount();
        updateJsonPreview();
      },100);
    });

    function generatePrompt(){
      const theme = document.getElementById('theme').value.trim();
      const contentType = document.getElementById('contentType').value;
      const testMode = document.getElementById('testMode').checked;
      
      let mediaSection = '';
      if (githubMediaCache) {
        const allFiles = [];
        for (const [folder, files] of Object.entries(githubMediaCache)) {
          files.forEach(file => {
            const relevance = calculateRelevance(file, intelligenceContext);
            if (relevance.score >= 5) { // Seulement pertinents/sugg√©r√©s
              allFiles.push({ folder, name: file, relevance: relevance.score, level: relevance.level });
            }
          });
        }
        allFiles.sort((a, b) => b.relevance - a.relevance);
        
        mediaSection = `\n### üéØ M√âDIAS PERTINENTS D√âTECT√âS (${allFiles.length})\n\n`;
        const top20 = allFiles.slice(0, 20);
        top20.forEach(f => {
          const badge = f.level === 'high' ? 'üéØ TR√àS PERTINENT' : 'üí° SUGG√âR√â';
          mediaSection += `${badge} ‚Üí ${f.folder}/${f.name}\n`;
        });
        if (allFiles.length > 20) {
          mediaSection += `\n... et ${allFiles.length - 20} autres m√©dias disponibles\n`;
        }
      } else {
        mediaSection = `\n‚ö†Ô∏è Analyse m√©dias non effectu√©e\n`;
      }

      const prompt =
`# üéØ PROMPT v2.1 - CONTENU INTERACTIF ENFANT

## CONTEXTE
- **Th√®me :** ${theme}
- **Type :** ${contentType}
- **Mode :** ${testMode ? 'Test local' : 'Production CDN'}

${mediaSection}

## INSTRUCTIONS
1. Utiliser PRIORITAIREMENT les m√©dias pertinents list√©s ci-dessus
2. ${testMode ? 'Chemins locaux : /images/, /audio/' : 'Utiliser CDN distant'}
3. G√©n√©rer tableau final : m√©dias utilis√©s ‚úÖ vs manquants ‚ùå

---
**Version :** ${document.getElementById('projectVersion').value}
**Objectifs :** ${getCheckedValues('pedGoals').join(', ') || 'Aucun'}`;

      document.getElementById('promptOutputModal').textContent = prompt;
      openResultModal();
    }

    // ===== COPIE / EXPORT =====
    document.getElementById('copyBtnModal').addEventListener('click', function(){
      const txt = document.getElementById('promptOutputModal').textContent;
      const btn = this; 
      btn.classList.add('loading'); 
      btn.disabled = true;
      navigator.clipboard.writeText(txt).then(()=>{
        setTimeout(()=>{
          btn.classList.remove('loading');
          btn.innerHTML = '<span>‚úÖ Copi√©</span>';
          setTimeout(()=>{ 
            btn.innerHTML = '<span class="spinner"></span><span>üìã Copier</span>'; 
            btn.disabled=false; 
          }, 2000);
        },300);
      }).catch(()=>{
        btn.classList.remove('loading'); 
        btn.disabled=false; 
        alert('‚ùå Erreur');
      });
    });

    document.getElementById('downloadBtnModal').addEventListener('click', function(){
      const txt = document.getElementById('promptOutputModal').textContent;
      const blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob); 
      const a = document.createElement('a');
      const theme = (document.getElementById('theme').value||'').replace(/[^a-z0-9]/gi,'_').toLowerCase();
      const ts = new Date().toISOString().slice(0,10);
      a.href = url; 
      a.download = `prompt_${theme}_${ts}.txt`;
      document.body.appendChild(a); 
      a.click(); 
      document.body.removeChild(a); 
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
```

---

## S√âCURIT√â
‚úÖ **OK** ‚Äî Am√©liorations v2.1 :
- Cache localStorage (1h validit√©)
- Validation contexte avant analyse
- Pas de stockage m√©dias volumineux
- Rate limit GitHub respect√©

---

## TESTS MANUELS

### **Test 1 : Intelligence contextuelle ‚úÖ**
```
1. Th√®me : "Les capitales de l'Alg√©rie"
2. Type : Quiz
3. Objectif : "Vocabulaire"
4. Cliquer "üîç Analyser m√©dias"
5. V√âRIFIER : M√©dias contenant ALGER/ORAN/CONSTANTINE en t√™te
6. V√âRIFIER : Badge "üéØ TR√àS PERTINENT"
7. R√âSULTAT : ‚úÖ Filtrage intelligent
```

### **Test 2 : Cache 1h ‚úÖ**
```
1. Analyser m√©dias une fois
2. Rafra√Æchir page (F5)
3. Re-cliquer "Analyser"
4. V√âRIFIER Console : "üì¶ Cache valide"
5. V√âRIFIER : R√©sultats instantan√©s
6. R√âSULTAT : ‚úÖ Cache fonctionnel
```

### **Test 3 : Auto-suggestion ‚úÖ**
```
1. Remplir th√®me SANS analyser
2. Passer au champ suivant (blur)
3. ATTENDRE 0.5s
4. V√âRIFIER : Banner orange "‚ö†Ô∏è Cliquez sur Analyser"
5. V√âRIFIER : Section clignote (animation pulse)
6. R√âSULTAT : ‚úÖ Suggestion active
```

### **Test 4 : Validation pr√©-g√©n√©ration ‚úÖ**
```
1. Remplir formulaire SANS analyser m√©dias
2. Cliquer "üöÄ G√©n√©rer Prompt"
3. V√âRIFIER : Popup "‚ö†Ô∏è M√©dias non v√©rifi√©s"
4. Choisir "OK" ‚Üí Lance analyse
5. Choisir "Annuler" ‚Üí G√©n√®re quand m√™me
6. R√âSULTAT : ‚úÖ Choix utilisateur respect√©
