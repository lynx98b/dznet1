<!DOCTYPE html>
<html lang="fr">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-CRRK6Z4D1X"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-CRRK6Z4D1X');
  </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histoires et Livres - Espace Enfants</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* [Tous les styles CSS pr√©c√©dents restent identiques] */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comic Sans MS', 'Chalkboard SE', cursive;
        }
        
        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #bbdefb 100%);
            color: #333;
            min-height: 1080px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1920px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            min-height: 1080px;
        }
        
        /* [Tous les autres styles restent identiques...] */
        
        /* Nouveaux styles pour les histoires audio */
        .carte-audio {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            cursor: pointer;
            border: 3px solid #ef476f;
        }
        
        .carte-audio:hover {
            transform: translateY(-5px);
        }
        
        .icone-audio {
            font-size: 40px;
            color: #ef476f;
            flex-shrink: 0;
        }
        
        .contenu-audio h3 {
            font-size: 18px;
            color: #5a189a;
            margin-bottom: 5px;
        }
        
        .contenu-audio p {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .duree-audio {
            color: #888;
            font-size: 12px;
        }
        
        .badge-audio {
            background: #ef476f;
            color: white;
        }
        
        .section-audio {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            border: 4px solid #ef476f;
        }
        
        .section-audio h2 {
            font-size: 32px;
            color: #5a189a;
            margin-bottom: 25px;
            text-align: center;
            text-shadow: 2px 2px 0px #ffafcc;
        }
        
        .grille-audio {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }
        
        /* [Le reste des styles reste identique] */
    </style>
</head>
<body>
    <div class="container">
        <!-- ZONE EN-T√äTE (BUB) -->
        <header class="zone-entete-bub">
            <div class="zone-logo">
                <div class="logo-icone flottant">
                    <i class="fas fa-book-open"></i>
                </div>
                <div class="texte-logo">Histoires et Livres</div>
            </div>
            <div class="zone-navigation">
                <button class="bouton-navigation" onclick="window.location.href='index.html'">
                    <i class="fas fa-home"></i> Accueil
                </button>
                <button class="bouton-navigation">
                    <i class="fas fa-user"></i> Mon Compte
                </button>
            </div>
        </header>
        
        <!-- ZONE TITRE PRINCIPAL -->
        <section class="zone-titre-principal">
            <h1>Biblioth√®que Magique</h1>
            <p>D√©couvre des histoires captivantes, des livres interactifs et des contes audio!</p>
        </section>
        
        <!-- ZONE RECHERCHE ET FILTRES -->
        <section class="zone-recherche-filtres">
            <div class="zone-recherche">
                <input type="text" class="champ-recherche" id="champRecherche" placeholder="Rechercher une histoire...">
                <button class="bouton-recherche" id="boutonRecherche">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            
            <button class="bouton-filtre actif" data-filtre="all">Tous</button>
            <button class="bouton-filtre" data-filtre="age-3-5">3-5 ans</button>
            <button class="bouton-filtre" data-filtre="age-6-8">6-8 ans</button>
            <button class="bouton-filtre" data-filtre="age-9-12">9-12 ans</button>
            <button class="bouton-filtre" data-filtre="type-html">Histoires</button>
            <button class="bouton-filtre" data-filtre="type-audio">Audio</button>
            <button class="bouton-filtre" data-filtre="categorie-contes">Contes</button>
            <button class="bouton-filtre" data-filtre="categorie-aventures">Aventures</button>
        </section>
        
        <div class="stats" id="stats">
            <span id="livreCount">Scan des histoires en cours...</span>
        </div>
        
        <!-- ZONE CONTENU PRINCIPAL -->
        <main class="zone-contenu-principal">
            <!-- Section histoires HTML -->
            <section class="section-livres" id="section-html">
                <h2>Histoires √† Lire</h2>
                <div class="grille-livres" id="grilleLivres">
                    <div class="loading">
                        <p>Recherche automatique des histoires...</p>
                    </div>
                </div>
            </section>
            
            <!-- Section histoires audio -->
            <section class="section-audio" id="section-audio">
                <h2>Histoires Audio</h2>
                <div class="grille-audio" id="grilleAudio">
                    <!-- Les histoires audio appara√Ætront ici -->
                </div>
            </section>
        </main>
        
        <!-- ZONE PIED DE PAGE -->
        <footer class="zone-pied-page">
            <div class="contenu-pied-page">
                <div class="info-contact">
                    <h3>Contact</h3>
                    <p><i class="fas fa-envelope"></i> enfants@monintranet.fr</p>
                    <p><i class="fas fa-phone"></i> 01 23 45 67 89</p>
                    <p><i class="fas fa-map-marker-alt"></i> 123 Rue des Enfants, Paris</p>
                </div>
                
                <div class="liens-rapides">
                    <h3>Liens Rapides</h3>
                    <ul>
                        <li><a href="index.html">Retour √† l'accueil</a></li>
                        <li><a href="#">Jeux √âducatifs</a></li>
                        <li><a href="#">Atelier Cr√©atif</a></li>
                        <li><a href="#">Espace Musique</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="copyright">
                &copy; 2023 Espace Enfants - Tous droits r√©serv√©s | Con√ßu avec <i class="fas fa-heart" style="color:#ff6b6b"></i> pour les enfants
            </div>
        </footer>
    </div>

    <script>
        // Configuration √âTENDUE pour inclure les fichiers audio
        const EXCLUDED_FILES = ['index.html', 'sommaire.html', 'histoires.html'];
        const imageExtensions = ['.jpg'];
        const audioExtensions = ['.mp3'];
        
        // √âtat des filtres
        let filtresActifs = {
            age: 'all',
            categorie: 'all',
            type: 'all',
            recherche: ''
        };
        
        let toutesLesHistoires = [];
        let tousLesAudios = [];

        // Fonction pour d√©tecter tous les fichiers (HTML + Audio)
        async function discoverAllFiles() {
            try {
                console.log('üîç D√©but du scan des fichiers...');
                
                let allFiles = [];
                let audioFiles = [];
                
                // Strat√©gie 1: Essayer de r√©cup√©rer la liste via fetch
                try {
                    const response = await fetch('./');
                    const text = await response.text();
                    
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'text/html');
                    const links = doc.querySelectorAll('a[href]');
                    
                    // Fichiers HTML
                    const htmlFiles = Array.from(links)
                        .map(link => link.getAttribute('href'))
                        .filter(file => 
                            file.endsWith('.html') && 
                            !EXCLUDED_FILES.includes(file)
                        );
                    
                    // Fichiers Audio
                    audioFiles = Array.from(links)
                        .map(link => link.getAttribute('href'))
                        .filter(file => 
                            audioExtensions.some(ext => file.toLowerCase().endsWith(ext))
                        );
                    
                    allFiles = [...htmlFiles];
                    console.log(`üìÅ Fichiers HTML trouv√©s:`, htmlFiles);
                    console.log(`üéµ Fichiers audio trouv√©s:`, audioFiles);
                    
                } catch (error) {
                    console.log('‚ùå Scan automatique √©chou√©, utilisation de la d√©tection par pattern');
                }
                
                // Si pas de fichiers trouv√©s, utiliser la d√©tection par pattern
                if (allFiles.length === 0) {
                    allFiles = await detectFilesByPattern('html');
                }
                if (audioFiles.length === 0) {
                    audioFiles = await detectFilesByPattern('audio');
                }
                
                return {
                    html: allFiles,
                    audio: audioFiles
                };
                
            } catch (error) {
                console.error('Erreur lors de la d√©couverte des fichiers:', error);
                return { html: [], audio: [] };
            }
        }

        // Fonction pour d√©tecter les fichiers par pattern
        async function detectFilesByPattern(type) {
            console.log(`üéØ D√©tection par pattern pour: ${type}`);
            
            const patterns = type === 'html' 
                ? ['histoire', 'hist', 'conte', 'livre', 'story']
                : ['audio', 'conte', 'histoire', 'story', 'narration'];
            
            const extensions = type === 'html' ? ['.html'] : audioExtensions;
            const discoveredFiles = [];
            
            // Tester les patterns avec num√©ros
            for (let i = 0; i <= 20; i++) {
                for (const pattern of patterns) {
                    for (const ext of extensions) {
                        const filename = `${pattern}${i}${ext}`;
                        if (await fileExists(filename)) {
                            discoveredFiles.push(filename);
                            console.log(`‚úÖ Trouv√©: ${filename}`);
                        }
                    }
                }
            }
            
            // Tester les patterns sans num√©ros
            for (const pattern of patterns) {
                for (const ext of extensions) {
                    const filename = `${pattern}${ext}`;
                    if (await fileExists(filename)) {
                        discoveredFiles.push(filename);
                        console.log(`‚úÖ Trouv√©: ${filename}`);
                    }
                }
            }
            
            // Chercher aussi les fichiers avec underscores
            for (const pattern of patterns) {
                const variations = ['aventure', 'conte', 'animaux', 'magique', 'dragon', 'princesse'];
                for (const variation of variations) {
                    for (const ext of extensions) {
                        const filename = `${pattern}_${variation}${ext}`;
                        if (await fileExists(filename)) {
                            discoveredFiles.push(filename);
                            console.log(`‚úÖ Trouv√©: ${filename}`);
                        }
                    }
                }
            }
            
            return discoveredFiles;
        }

        // Fonction pour v√©rifier si un fichier existe
        async function fileExists(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        // Fonction pour extraire les m√©tadonn√©es d'un fichier HTML
        async function extractFileInfo(filename) {
            try {
                const response = await fetch(filename);
                const html = await response.text();
                
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Extraire le titre
                const title = doc.querySelector('title')?.textContent || 
                             filename.replace('.html', '')
                                    .replace(/_/g, ' ')
                                    .replace(/([a-z])([A-Z])/g, '$1 $2')
                                    .replace(/\b\w/g, l => l.toUpperCase());
                
                // Extraire la description
                let description = doc.querySelector('meta[name="description"]')?.getAttribute('content') || '';
                
                if (!description) {
                    const firstParagraph = doc.querySelector('p');
                    if (firstParagraph) {
                        description = firstParagraph.textContent.substring(0, 120) + '...';
                    } else {
                        const firstH1 = doc.querySelector('h1');
                        description = firstH1 ? firstH1.textContent + " - Histoire pour enfants" : "Histoire pour enfants";
                    }
                }
                
                // Extraire les m√©tadonn√©es personnalis√©es
                const age = doc.querySelector('meta[name="age"]')?.getAttribute('content') || '3-5';
                const categorie = doc.querySelector('meta[name="categorie"]')?.getAttribute('content') || 'contes';
                const type = 'html';
                
                // Chercher le logo
                const logoUrl = await findStoryLogo(filename);
                
                return {
                    filename,
                    title,
                    description,
                    url: filename,
                    logoUrl,
                    age,
                    categorie,
                    type
                };
            } catch (error) {
                console.error(`Erreur avec ${filename}:`, error);
                return {
                    filename,
                    title: filename.replace('.html', '')
                                  .replace(/_/g, ' ')
                                  .replace(/([a-z])([A-Z])/g, '$1 $2')
                                  .replace(/\b\w/g, l => l.toUpperCase()),
                    description: "Histoire pour enfants",
                    url: filename,
                    logoUrl: null,
                    age: '3-5',
                    categorie: 'contes',
                    type: 'html'
                };
            }
        }

        // Fonction pour cr√©er les infos des fichiers audio
        async function createAudioInfo(filename) {
            // Essayer de trouver un fichier d'image associ√©
            const baseName = filename.replace(/\.(mp3|wav|ogg|m4a|aac)$/i, '');
            const imageUrl = await findStoryLogo(baseName);
            
            // Essayer de trouver un fichier HTML de description associ√©
            let title = baseName.replace(/_/g, ' ')
                              .replace(/([a-z])([A-Z])/g, '$1 $2')
                              .replace(/\b\w/g, l => l.toUpperCase());
            
            let description = "Histoire audio pour enfants";
            
            // V√©rifier s'il existe un fichier HTML avec le m√™me nom
            const htmlFile = `${baseName}.html`;
            if (await fileExists(htmlFile)) {
                try {
                    const response = await fetch(htmlFile);
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    title = doc.querySelector('title')?.textContent || title;
                    description = doc.querySelector('meta[name="description"]')?.getAttribute('content') || description;
                } catch (error) {
                    console.log(`Pas de fichier HTML associ√© pour ${filename}`);
                }
            }
            
            return {
                filename,
                title,
                description,
                url: filename,
                logoUrl: imageUrl,
                age: '3-5', // Valeur par d√©faut
                categorie: 'contes', // Valeur par d√©faut
                type: 'audio'
            };
        }

        // Fonction pour trouver le logo/illustration
        async function findStoryLogo(baseFilename) {
            const baseName = baseFilename.replace(/\.(html|mp3|wav|ogg|m4a|aac)$/i, '');
            
            // Tester toutes les extensions d'image
            for (const ext of imageExtensions) {
                const imageUrl = `${baseName}${ext}`;
                const exists = await checkImageExists(imageUrl);
                if (exists) {
                    return imageUrl;
                }
            }
            
            return null;
        }

        // Fonction pour v√©rifier si une image existe
        function checkImageExists(imageUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                const timeout = setTimeout(() => resolve(false), 2000);
                
                img.onload = () => {
                    clearTimeout(timeout);
                    resolve(true);
                };
                img.onerror = () => {
                    clearTimeout(timeout);
                    resolve(false);
                };
                img.src = imageUrl;
            });
        }

        // Fonction pour filtrer les contenus
        function filtrerContenus(contenus) {
            return contenus.filter(contenu => {
                // Filtre par √¢ge
                if (filtresActifs.age !== 'all' && !contenu.age.includes(filtresActifs.age.replace('age-', ''))) {
                    return false;
                }
                
                // Filtre par cat√©gorie
                if (filtresActifs.categorie !== 'all' && !contenu.categorie.includes(filtresActifs.categorie.replace('categorie-', ''))) {
                    return false;
                }
                
                // Filtre par type
                if (filtresActifs.type !== 'all' && contenu.type !== filtresActifs.type.replace('type-', '')) {
                    return false;
                }
                
                // Filtre par recherche
                if (filtresActifs.recherche) {
                    const termeRecherche = filtresActifs.recherche.toLowerCase();
                    return contenu.title.toLowerCase().includes(termeRecherche) || 
                           contenu.description.toLowerCase().includes(termeRecherche);
                }
                
                return true;
            });
        }

        // Fonction pour afficher les histoires HTML
        function afficherHistoires(histoires) {
            const grilleLivres = document.getElementById('grilleLivres');
            const sectionHtml = document.getElementById('section-html');
            
            const histoiresHTML = histoires.filter(h => h.type === 'html');
            
            if (histoiresHTML.length === 0) {
                grilleLivres.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-book" style="font-size: 50px; margin-bottom: 20px; color: #ccc;"></i>
                        <h3>Aucune histoire trouv√©e</h3>
                        <p>Aucune histoire ne correspond √† vos crit√®res de recherche.</p>
                    </div>
                `;
                sectionHtml.style.display = 'none';
            } else {
                sectionHtml.style.display = 'block';
                grilleLivres.innerHTML = histoiresHTML.map(histoire => `
                    <div class="carte-livre" onclick="window.location.href='${histoire.url}'">
                        <div class="image-livre">
                            ${histoire.logoUrl ? 
                                `<img src="${histoire.logoUrl}" alt="${histoire.title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                 <div class="default-icon" style="display:none;">üìñ</div>` :
                                `<div class="default-icon">üìñ</div>`
                            }
                        </div>
                        <div class="contenu-livre">
                            <h3 class="game-title">${histoire.title}</h3>
                            <div class="metadonnees">
                                <span class="badge badge-age">${histoire.age} ans</span>
                                <span class="badge badge-categorie">${histoire.categorie}</span>
                                <span class="badge badge-type">${histoire.type}</span>
                            </div>
                            <p class="game-description">${histoire.description}</p>
                            <a href="${histoire.url}" class="bouton-lire">Lire l'histoire</a>
                            <div class="file-name">${histoire.filename}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Fonction pour afficher les histoires audio
        function afficherAudios(audios) {
            const grilleAudio = document.getElementById('grilleAudio');
            const sectionAudio = document.getElementById('section-audio');
            
            const audiosFiltres = audios.filter(a => a.type === 'audio');
            
            if (audiosFiltres.length === 0) {
                grilleAudio.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-headphones" style="font-size: 50px; margin-bottom: 20px; color: #ccc;"></i>
                        <h3>Aucune histoire audio trouv√©e</h3>
                        <p>Aucune histoire audio ne correspond √† vos crit√®res de recherche.</p>
                    </div>
                `;
                sectionAudio.style.display = 'none';
            } else {
                sectionAudio.style.display = 'block';
                grilleAudio.innerHTML = audiosFiltres.map(audio => `
                    <div class="carte-audio" onclick="jouerAudio('${audio.url}')">
                        <div class="icone-audio">
                            <i class="fas fa-play-circle"></i>
                        </div>
                        <div class="contenu-audio">
                            <h3>${audio.title}</h3>
                            <div class="metadonnees">
                                <span class="badge badge-age">${audio.age} ans</span>
                                <span class="badge badge-categorie">${audio.categorie}</span>
                                <span class="badge badge-audio">Audio</span>
                            </div>
                            <p>${audio.description}</p>
                            <div class="duree-audio">Fichier: ${audio.filename}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Fonction pour jouer un audio
        function jouerAudio(url) {
            // Cr√©er un lecteur audio simple
            const audio = new Audio(url);
            audio.play().catch(e => {
                console.error("Erreur de lecture audio:", e);
                alert(`Impossible de lire l'audio: ${url}\n\nV√©rifiez que le fichier existe et est accessible.`);
            });
            
            // Optionnel: Afficher un contr√¥leur audio
            const existingPlayer = document.getElementById('audio-player');
            if (existingPlayer) {
                existingPlayer.remove();
            }
            
            const audioPlayer = document.createElement('div');
            audioPlayer.id = 'audio-player';
            audioPlayer.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: white;
                padding: 15px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 1000;
                border: 3px solid #ef476f;
            `;
            
            audioPlayer.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button onclick="this.parentElement.parentElement.querySelector('audio').pause(); this.parentElement.parentElement.remove();" style="background: #ef476f; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">√ó</button>
                    <div>
                        <div style="font-weight: bold; margin-bottom: 5px;">Lecture en cours</div>
                        <audio controls style="width: 200px;">
                            <source src="${url}" type="audio/mpeg">
                            Votre navigateur ne supporte pas l'audio.
                        </audio>
                    </div>
                </div>
            `;
            
            document.body.appendChild(audioPlayer);
        }

        // Fonction principale
        async function loadAllContentAutomatically() {
            const statsElement = document.getElementById('livreCount');
            
            try {
                statsElement.textContent = 'üîç Recherche des fichiers...';
                
                // D√©couvrir automatiquement les fichiers
                const discoveredFiles = await discoverAllFiles();
                
                if (discoveredFiles.html.length === 0 && discoveredFiles.audio.length === 0) {
                    statsElement.textContent = '‚ùå Aucun fichier trouv√©';
                    return;
                }
                
                statsElement.textContent = `üìÅ ${discoveredFiles.html.length} histoire(s) ‚Ä¢ üéµ ${discoveredFiles.audio.length} audio(s) - Chargement...`;
                
                // Charger les informations des fichiers HTML
                const storiesPromises = discoveredFiles.html.map(extractFileInfo);
                const htmlStories = await Promise.all(storiesPromises);
                
                // Charger les informations des fichiers audio
                const audioPromises = discoveredFiles.audio.map(createAudioInfo);
                const audioStories = await Promise.all(audioPromises);
                
                // Combiner tous les contenus
                toutesLesHistoires = [...htmlStories, ...audioStories];
                
                // Afficher tout le contenu initialement
                afficherToutContenu();
                
            } catch (error) {
                console.error('Erreur g√©n√©rale:', error);
                statsElement.textContent = '‚ùå Erreur lors du chargement';
            }
        }

        // Fonction pour afficher tout le contenu
        function afficherToutContenu() {
            const statsElement = document.getElementById('livreCount');
            const contenusFiltres = filtrerContenus(toutesLesHistoires);
            
            const htmlCount = contenusFiltres.filter(c => c.type === 'html').length;
            const audioCount = contenusFiltres.filter(c => c.type === 'audio').length;
            
            statsElement.textContent = `üìö ${htmlCount} histoire(s) ‚Ä¢ üéµ ${audioCount} audio(s) trouv√©(s)`;
            
            afficherHistoires(contenusFiltres);
            afficherAudios(contenusFiltres);
        }

        // Gestion des filtres
        document.querySelectorAll('.bouton-filtre').forEach(bouton => {
            bouton.addEventListener('click', function() {
                document.querySelectorAll('.bouton-filtre').forEach(btn => {
                    btn.classList.remove('actif');
                });
                this.classList.add('actif');
                
                const filtre = this.getAttribute('data-filtre');
                if (filtre.startsWith('age-')) {
                    filtresActifs.age = filtre;
                } else if (filtre.startsWith('categorie-')) {
                    filtresActifs.categorie = filtre;
                } else if (filtre.startsWith('type-')) {
                    filtresActifs.type = filtre;
                } else if (filtre === 'all') {
                    filtresActifs.age = 'all';
                    filtresActifs.categorie = 'all';
                    filtresActifs.type = 'all';
                }
                
                afficherToutContenu();
            });
        });

        // Gestion de la recherche
        document.getElementById('boutonRecherche').addEventListener('click', function() {
            filtresActifs.recherche = document.getElementById('champRecherche').value;
            afficherToutContenu();
        });

        document.getElementById('champRecherche').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                filtresActifs.recherche = this.value;
                afficherToutContenu();
            }
        });

        // D√©marrer automatiquement au chargement
        document.addEventListener('DOMContentLoaded', loadAllContentAutomatically);
    </script>
</body>
</html>
