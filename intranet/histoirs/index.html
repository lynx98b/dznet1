<script>
    // Configuration
    const METADATA_URL = '/stories-metadata.json';
    const DOSSIER_CIBLE = 'intranet/histoirs'; // ‚Üê DOSSIER LIMITE
    
    // √âtat des filtres
    let filtresActifs = {
        age: 'all',
        categorie: 'all',
        type: 'all',
        recherche: ''
    };
    
    let toutesLesHistoires = [];
    let categoriesUniques = new Set();
    let typesUniques = new Set();

    // Charger les m√©tadonn√©es
    async function loadStoriesMetadata() {
        const grilleLivres = document.getElementById('grilleLivres');
        const statsElement = document.getElementById('livreCount');
        
        try {
            statsElement.innerHTML = '<i class="fas fa-sync-alt spin"></i> Chargement des histoires...';
            
            const response = await fetch(METADATA_URL);
            if (!response.ok) throw new Error('Fichier de m√©tadonn√©es non trouv√©');
            
            const data = await response.json();
            
            // FILTRER UNIQUEMENT LE DOSSIER intranet/histoirs
            toutesLesHistoires = data.stories.filter(histoire => 
                histoire.directory === DOSSIER_CIBLE || 
                histoire.filename.startsWith(DOSSIER_CIBLE + '/')
            );
            
            console.log(`üìÅ Histoires trouv√©es dans ${DOSSIER_CIBLE}:`, toutesLesHistoires.length);
            
            // Extraire les filtres uniques
            extraireFiltresUniques();
            
            // Peupler les menus d√©roulants
            peuplerFiltresAvances();
            
            // Afficher les histoires
            afficherHistoires(toutesLesHistoires);
            
            // Mettre √† jour les stats
            const lastUpdate = new Date(data.generatedAt).toLocaleDateString('fr-FR');
            const histoiresAvecImages = toutesLesHistoires.filter(h => h.logoUrl).length;
            
            statsElement.innerHTML = 
                `üìö ${toutesLesHistoires.length} histoires ‚Ä¢ üñºÔ∏è ${histoiresAvecImages} avec images ‚Ä¢ üìÖ Mise √† jour: ${lastUpdate}`;
                
        } catch (error) {
            console.error('Erreur:', error);
            statsElement.innerHTML = '<span style="color:#ff6b6b"><i class="fas fa-exclamation-triangle"></i> Erreur de chargement</span>';
            grilleLivres.innerHTML = `
                <div class="error-state">
                    <h2><i class="fas fa-exclamation-triangle"></i> Erreur de chargement</h2>
                    <p>Impossible de charger la biblioth√®que des histoires.</p>
                    <p>V√©rifiez que le fichier stories-metadata.json est pr√©sent.</p>
                    <button onclick="loadStoriesMetadata()" class="bouton-lire" style="margin-top:15px; width:auto;">
                        <i class="fas fa-redo"></i> R√©essayer
                    </button>
                </div>
            `;
        }
    }

    function extraireFiltresUniques() {
        toutesLesHistoires.forEach(histoire => {
            categoriesUniques.add(histoire.categorie);
            typesUniques.add(histoire.type);
        });
    }

    function peuplerFiltresAvances() {
        const categorySelect = document.getElementById('filterCategory');
        const typeSelect = document.getElementById('filterType');
        const folderSelect = document.getElementById('filterFolder');
        
        // Vider les selects
        categorySelect.innerHTML = '<option value="all">Toutes les cat√©gories</option>';
        typeSelect.innerHTML = '<option value="all">Tous les types</option>';
        folderSelect.innerHTML = '<option value="all">Tous les dossiers</option>';
        
        // Cat√©gories
        [...categoriesUniques].sort().forEach(categorie => {
            const option = document.createElement('option');
            option.value = categorie;
            option.textContent = categorie.charAt(0).toUpperCase() + categorie.slice(1);
            categorySelect.appendChild(option);
        });
        
        // Types
        [...typesUniques].sort().forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
            typeSelect.appendChild(option);
        });
        
        // Cacher le filtre dossier puisqu'on n'a qu'un seul dossier
        document.querySelector('.filters-advanced').style.display = 'none';
    }

    function filtrerHistoires() {
        const searchTerm = document.getElementById('champRecherche').value.toLowerCase();
        const category = document.getElementById('filterCategory').value;
        const type = document.getElementById('filterType').value;
        const ageFilter = document.querySelector('.bouton-filtre.actif')?.dataset.filtre || 'all';
        
        return toutesLesHistoires.filter(histoire => {
            // Filtre recherche
            if (searchTerm && 
                !histoire.title.toLowerCase().includes(searchTerm) && 
                !histoire.description.toLowerCase().includes(searchTerm)) {
                return false;
            }
            
            // Filtre cat√©gorie
            if (category !== 'all' && histoire.categorie !== category) {
                return false;
            }
            
            // Filtre type
            if (type !== 'all' && histoire.type !== type) {
                return false;
            }
            
            // Filtre √¢ge
            if (ageFilter !== 'all' && !histoire.age.includes(ageFilter.replace('age-', ''))) {
                return false;
            }
            
            return true;
        });
    }

    function afficherHistoires(histoires) {
        const grilleLivres = document.getElementById('grilleLivres');
        
        if (histoires.length === 0) {
            grilleLivres.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search" style="font-size: 50px; margin-bottom: 20px; color: #ccc;"></i>
                    <h3>Aucune histoire trouv√©e</h3>
                    <p>Aucune histoire ne correspond √† vos crit√®res de recherche dans le dossier ${DOSSIER_CIBLE}.</p>
                    <p>Essayez de modifier vos filtres ou votre recherche.</p>
                </div>
            `;
            return;
        }
        
        grilleLivres.innerHTML = histoires.map(histoire => {
            // Corriger l'URL pour √©viter les doubles chemins
            let url = histoire.url;
            
            // Si l'URL commence d√©j√† par /, la garder telle quelle
            if (!url.startsWith('/')) {
                // Sinon, s'assurer que c'est un chemin relatif correct
                url = '/' + url;
            }
            
            // Nettoyer les doubles slashes accidentels
            url = url.replace(/\/\//g, '/');
            
            return `
                <div class="carte-livre" onclick="window.location.href='${url}'">
                    <div class="image-livre">
                        ${histoire.logoUrl ? 
                            `<img src="${histoire.logoUrl}" alt="${histoire.title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                             <div class="default-icon" style="display:none;">üìñ</div>` :
                            `<div class="default-icon">üìñ</div>`
                        }
                    </div>
                    <div class="contenu-livre">
                        <h3>${histoire.title}</h3>
                        <div class="metadonnees">
                            <span class="badge badge-age">${histoire.age} ans</span>
                            <span class="badge badge-categorie">${histoire.categorie}</span>
                            <span class="badge badge-type">${histoire.type}</span>
                        </div>
                        <p>${histoire.description}</p>
                        <a href="${url}" class="bouton-lire" onclick="event.stopPropagation()">
                            <i class="fas fa-book-open"></i> Lire l'histoire
                        </a>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Gestion des √©v√©nements
    document.querySelectorAll('.bouton-filtre').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.bouton-filtre').forEach(b => b.classList.remove('actif'));
            this.classList.add('actif');
            afficherHistoires(filtrerHistoires());
        });
    });

    document.getElementById('boutonRecherche').addEventListener('click', () => {
        afficherHistoires(filtrerHistoires());
    });

    document.getElementById('champRecherche').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') afficherHistoires(filtrerHistoires());
    });

    document.getElementById('filterCategory').addEventListener('change', () => {
        afficherHistoires(filtrerHistoires());
    });

    document.getElementById('filterType').addEventListener('change', () => {
        afficherHistoires(filtrerHistoires());
    });

    // D√©marrer au chargement
    document.addEventListener('DOMContentLoaded', loadStoriesMetadata);
</script>
