<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barre de Navigation v2.0 SECURE - dznet1.com</title>
    <style>
        /* Barre de navigation */
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary, #4A6FA5);
            padding: 15px 20px;
            border-radius: 12px;
            margin: 30px 0 20px 0;
            flex-wrap: wrap;
            gap: 10px;
            position: relative;
        }

        .nav-btn {
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            min-width: 60px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Comic Sans MS', cursive, sans-serif;
        }

        .nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .nav-btn.hidden {
            display: none !important;
        }

        .nav-btn.loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .nav-prev {
            background: var(--secondary, #6B8C42);
            color: var(--on-secondary, #FFFFFF);
        }

        .nav-next {
            background: var(--accent, #E67E22);
            color: var(--on-primary, #FFFFFF);
        }

        .nav-menu {
            background: #6c757d;
            color: white;
        }

        .nav-finish {
            background: #28a745;
            color: white;
        }

        .page-indicator {
            color: var(--on-primary, #FFFFFF);
            font-weight: bold;
            font-size: 18px;
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 6px;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nav-icon {
            font-size: 20px;
            margin: 0;
        }

        .nav-text {
            display: none;
        }

        /* Loader */
        .nav-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: none;
        }

        .nav-loader.active {
            display: block;
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Version desktop - afficher le texte */
        @media (min-width: 769px) {
            .nav-btn {
                min-width: 120px;
                gap: 8px;
            }
            
            .nav-text {
                display: inline;
                font-size: 14px;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-bar {
                flex-direction: row;
                justify-content: space-around;
                gap: 5px;
                padding: 10px;
            }
            
            .nav-btn {
                flex: 1;
                min-width: auto;
                height: 45px;
                padding: 10px;
            }
            
            .page-indicator {
                order: -1;
                flex: 0 0 100%;
                justify-content: center;
                margin-bottom: 10px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- BARRE DE NAVIGATION INTELLIGENTE v2.0 SECURE -->
    <div class="nav-bar" id="navigation-bar">
        <button class="nav-btn nav-prev hidden" 
                onclick="Navigation.goToPrevious()" 
                id="nav-prev-btn" 
                aria-label="Activit√© pr√©c√©dente"
                title="Activit√© pr√©c√©dente">
            <span class="nav-icon">‚óÄ</span>
            <span class="nav-text">Pr√©c√©dent</span>
        </button>
        
        <button class="nav-btn nav-next hidden" 
                onclick="Navigation.goToNext()" 
                id="nav-next-btn"
                aria-label="Activit√© suivante"
                title="Activit√© suivante">
            <span class="nav-icon">‚ñ∂</span>
            <span class="nav-text">Suivant</span>
        </button>
        
        <button class="nav-btn nav-menu" 
                onclick="Navigation.goToMainMenu()"
                aria-label="Retour au menu principal"
                title="Menu principal">
            <span class="nav-icon">üè†</span>
            <span class="nav-text">Menu</span>
        </button>
        
        <button class="nav-btn nav-finish" 
                onclick="Navigation.finishActivity()" 
                id="nav-finish-btn"
                aria-label="Terminer l'activit√©"
                title="Terminer l'activit√©">
            <span class="nav-icon">‚úì</span>
            <span class="nav-text">Termin√©</span>
        </button>
        
        <div class="page-indicator" 
             role="status" 
             aria-live="polite"
             title="Activit√© actuelle">
            <span class="nav-icon">üìÅ</span>
            <span id="nav-current-file">...</span>
        </div>
        
        <div class="nav-loader" id="nav-loader"></div>
    </div>

    <script>
        // ===== [v2.0.001] SYST√àME DE NAVIGATION S√âCURIS√â =====
        const Navigation = {
            // Config
            VERSION: '2.0.001',
            FETCH_TIMEOUT: 3000, // 3 secondes
            FILENAME_PATTERN: /^[a-zA-Z0-9_-]+\.html$/, // Validation stricte
            
            // √âtat
            currentFile: '',
            filePattern: '',
            fileNumber: 0,
            filePrefix: '',
            fileExtension: '.html',
            
            // ‚úÖ [MITIGATION 3] Cache des v√©rifications de fichiers
            fileCache: {},
            
            // [MITIGATION 4] √âtat de chargement
            isLoading: false,
            
            // ===== INITIALISATION =====
            init: function() {
                try {
                    this.detectCurrentFile();
                    this.detectFilePattern();
                    this.updateNavigation();
                    this.initKeyboardShortcuts();
                    console.log(`[Navigation v${this.VERSION}] Initialis√© avec succ√®s`);
                } catch (error) {
                    console.error('[Navigation] Erreur init:', error);
                    this.handleError('Erreur d\'initialisation de la navigation');
                }
            },
            
            // ===== [MITIGATION 1] D√âTECTION S√âCURIS√âE DU FICHIER =====
            detectCurrentFile: function() {
                try {
                    const path = window.location.pathname;
                    let filename = path.split('/').pop() || 'index.html';
                    
                    // ‚úÖ Validation stricte contre path traversal
                    if (!this.FILENAME_PATTERN.test(filename)) {
                        console.warn(`[Navigation] Filename invalide d√©tect√©: "${filename}", fallback index.html`);
                        filename = 'index.html';
                    }
                    
                    // Sanitize - supprimer caract√®res dangereux
                    filename = filename.replace(/[^a-zA-Z0-9_.-]/g, '');
                    
                    this.currentFile = filename;
                    
                    const displayElement = document.getElementById('nav-current-file');
                    if (displayElement) {
                        // ‚úÖ textContent (pas innerHTML) pour √©viter XSS
                        displayElement.textContent = filename;
                    }
                } catch (error) {
                    console.error('[Navigation] Erreur detectCurrentFile:', error);
                    this.currentFile = 'index.html';
                }
            },
            
            // ===== D√âTECTION DU PATTERN =====
            detectFilePattern: function() {
                try {
                    const filename = this.currentFile;
                    
                    // Patterns support√©s: jeux001.html, L_gest001.html, activite001.html
                    const match = filename.match(/^([a-zA-Z0-9_-]*)(\d+)\.html$/);
                    
                    if (match) {
                        this.filePrefix = match[1];
                        this.fileNumber = parseInt(match[2], 10);
                        this.filePattern = this.filePrefix + '###.html';
                        console.log(`[Navigation] Pattern d√©tect√©: ${this.filePattern}, num√©ro: ${this.fileNumber}`);
                    } else {
                        this.filePrefix = '';
                        this.fileNumber = 0;
                        this.filePattern = '';
                        console.log('[Navigation] Aucun pattern num√©rique d√©tect√©');
                    }
                } catch (error) {
                    console.error('[Navigation] Erreur detectFilePattern:', error);
                    this.filePattern = '';
                }
            },
            
            // ===== G√âN√âRATION S√âCURIS√âE DE FILENAME =====
            generateFilename: function(number) {
                if (!this.filePattern) return null;
                
                // Validation du num√©ro
                if (!Number.isInteger(number) || number < 1 || number > 999) {
                    console.warn(`[Navigation] Num√©ro invalide: ${number}`);
                    return null;
                }
                
                const numStr = number.toString().padStart(3, '0');
                const filename = this.filePattern.replace('###', numStr);
                
                // ‚úÖ Double validation
                if (!this.FILENAME_PATTERN.test(filename)) {
                    console.error(`[Navigation] Filename g√©n√©r√© invalide: ${filename}`);
                    return null;
                }
                
                return filename;
            },
            
            // ===== [MITIGATION 2 & 3] V√âRIFICATION FICHIER AVEC TIMEOUT ET CACHE =====
            checkFileExists: function(filename, callback) {
                // ‚úÖ Validation du filename
                if (!filename || !this.FILENAME_PATTERN.test(filename)) {
                    console.warn(`[Navigation] checkFileExists: filename invalide "${filename}"`);
                    callback(false);
                    return;
                }
                
                // ‚úÖ [CACHE] V√©rifier si d√©j√† en cache
                if (this.fileCache.hasOwnProperty(filename)) {
                    console.log(`[Navigation] Cache hit: ${filename} = ${this.fileCache[filename]}`);
                    callback(this.fileCache[filename]);
                    return;
                }
                
                // ‚úÖ [TIMEOUT] AbortController pour timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    console.warn(`[Navigation] Timeout (${this.FETCH_TIMEOUT}ms) pour: ${filename}`);
                }, this.FETCH_TIMEOUT);
                
                fetch(filename, { 
                    method: 'HEAD',
                    signal: controller.signal,
                    cache: 'no-cache' // √âviter cache navigateur
                })
                .then(response => {
                    clearTimeout(timeoutId);
                    const exists = response.status === 200;
                    
                    // ‚úÖ [CACHE] Stocker le r√©sultat
                    this.fileCache[filename] = exists;
                    
                    console.log(`[Navigation] V√©rification ${filename}: ${exists ? 'OK' : 'NOT FOUND'}`);
                    callback(exists);
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    
                    // ‚úÖ [ERROR HANDLING] Gestion fine des erreurs
                    if (error.name === 'AbortError') {
                        console.warn(`[Navigation] Timeout atteint pour: ${filename}`);
                    } else {
                        console.error(`[Navigation] Erreur fetch ${filename}:`, error.message);
                    }
                    
                    // En cas d'erreur, on assume que le fichier n'existe pas
                    this.fileCache[filename] = false;
                    callback(false);
                });
            },
            
            // ===== MISE √Ä JOUR DE LA NAVIGATION =====
            updateNavigation: function() {
                if (this.isLoading) {
                    console.log('[Navigation] updateNavigation d√©j√† en cours, skip');
                    return;
                }
                
                this.isLoading = true;
                this.showLoader();
                
                const prevBtn = document.getElementById('nav-prev-btn');
                const nextBtn = document.getElementById('nav-next-btn');
                
                // R√©initialiser
                if (prevBtn) prevBtn.classList.add('hidden');
                if (nextBtn) nextBtn.classList.add('hidden');
                
                if (!this.filePattern) {
                    console.log('[Navigation] Pattern de fichier non d√©tect√©');
                    this.hideLoader();
                    this.isLoading = false;
                    return;
                }
                
                // ‚úÖ Utiliser Promise.all pour √©viter race conditions
                const checks = [];
                
                // V√©rifier fichier pr√©c√©dent
                const prevFileNumber = this.fileNumber - 1;
                if (prevFileNumber >= 1) {
                    const prevFilename = this.generateFilename(prevFileNumber);
                    if (prevFilename) {
                        checks.push(
                            new Promise(resolve => {
                                this.checkFileExists(prevFilename, (exists) => {
                                    if (exists && prevBtn) {
                                        prevBtn.classList.remove('hidden');
                                        prevBtn.setAttribute('aria-label', `Activit√© pr√©c√©dente: ${prevFilename}`);
                                        prevBtn.title = `Activit√© pr√©c√©dente: ${prevFilename}`;
                                    }
                                    resolve();
                                });
                            })
                        );
                    }
                }
                
                // V√©rifier fichier suivant
                const nextFileNumber = this.fileNumber + 1;
                const nextFilename = this.generateFilename(nextFileNumber);
                if (nextFilename) {
                    checks.push(
                        new Promise(resolve => {
                            this.checkFileExists(nextFilename, (exists) => {
                                if (exists && nextBtn) {
                                    nextBtn.classList.remove('hidden');
                                    nextBtn.setAttribute('aria-label', `Activit√© suivante: ${nextFilename}`);
                                    nextBtn.title = `Activit√© suivante: ${nextFilename}`;
                                }
                                resolve();
                            });
                        })
                    );
                }
                
                // Attendre toutes les v√©rifications
                Promise.all(checks).finally(() => {
                    this.hideLoader();
                    this.isLoading = false;
                    console.log('[Navigation] Mise √† jour termin√©e');
                });
            },
            
            // ===== NAVIGATION =====
            goToPrevious: function() {
                try {
                    const prevFileNumber = this.fileNumber - 1;
                    if (prevFileNumber >= 1) {
                        const prevFilename = this.generateFilename(prevFileNumber);
                        if (prevFilename && this.fileCache[prevFilename] === true) {
                            console.log(`[Navigation] Redirection vers: ${prevFilename}`);
                            window.location.href = prevFilename;
                        } else {
                            console.warn('[Navigation] Fichier pr√©c√©dent non disponible');
                        }
                    }
                } catch (error) {
                    this.handleError('Erreur lors de la navigation pr√©c√©dente', error);
                }
            },
            
            goToNext: function() {
                try {
                    const nextFileNumber = this.fileNumber + 1;
                    const nextFilename = this.generateFilename(nextFileNumber);
                    
                    if (nextFilename && this.fileCache[nextFilename] === true) {
                        console.log(`[Navigation] Redirection vers: ${nextFilename}`);
                        window.location.href = nextFilename;
                    } else {
                        console.warn('[Navigation] Fichier suivant non disponible');
                    }
                } catch (error) {
                    this.handleError('Erreur lors de la navigation suivante', error);
                }
            },
            
            goToMainMenu: function() {
                try {
                    console.log('[Navigation] Retour au menu principal');
                    window.location.href = 'index.html';
                } catch (error) {
                    this.handleError('Erreur lors du retour au menu', error);
                }
            },
            
            finishActivity: function() {
                try {
                    const nextFileNumber = this.fileNumber + 1;
                    const nextFilename = this.generateFilename(nextFileNumber);
                    
                    if (nextFilename) {
                        this.checkFileExists(nextFilename, (exists) => {
                            if (exists) {
                                if (confirm('Bravo ! Passer √† l\'activit√© suivante ?')) {
                                    window.location.href = nextFilename;
                                }
                            } else {
                                if (confirm('Bravo ! Vous avez termin√© toutes les activit√©s. Retourner au menu ?')) {
                                    this.goToMainMenu();
                                }
                            }
                        });
                    } else {
                        if (confirm('Bravo ! Retourner au menu ?')) {
                            this.goToMainMenu();
                        }
                    }
                } catch (error) {
                    this.handleError('Erreur lors de la finalisation', error);
                }
            },
            
            // ===== RACCOURCIS CLAVIER =====
            initKeyboardShortcuts: function() {
                document.addEventListener('keydown', (e) => {
                    // Ignorer si dans un input
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    switch(e.key) {
                        case 'ArrowLeft':
                            e.preventDefault();
                            const prevBtn = document.getElementById('nav-prev-btn');
                            if (prevBtn && !prevBtn.classList.contains('hidden')) {
                                this.goToPrevious();
                            }
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            const nextBtn = document.getElementById('nav-next-btn');
                            if (nextBtn && !nextBtn.classList.contains('hidden')) {
                                this.goToNext();
                            }
                            break;
                        case 'Home':
                        case 'h':
                            e.preventDefault();
                            this.goToMainMenu();
                            break;
                    }
                });
            },
            
            // ===== LOADER =====
            showLoader: function() {
                const loader = document.getElementById('nav-loader');
                if (loader) loader.classList.add('active');
            },
            
            hideLoader: function() {
                const loader = document.getElementById('nav-loader');
                if (loader) loader.classList.remove('active');
            },
            
            // ===== [MITIGATION 4] GESTION D'ERREURS =====
            handleError: function(message, error = null) {
                console.error(`[Navigation ERROR] ${message}`, error);
                
                // Optionnel: afficher un toast/alert √† l'utilisateur
                // alert(`Erreur de navigation: ${message}`);
                
                // R√©initialiser l'√©tat
                this.isLoading = false;
                this.hideLoader();
            },
            
            // ===== PATTERN CUSTOM (optionnel) =====
            setCustomPattern: function(prefix, currentNumber) {
                try {
                    // Validation
                    if (!/^[a-zA-Z0-9_-]+$/.test(prefix)) {
                        throw new Error('Pr√©fixe invalide');
                    }
                    if (!Number.isInteger(currentNumber) || currentNumber < 1) {
                        throw new Error('Num√©ro invalide');
                    }
                    
                    this.filePrefix = prefix;
                    this.fileNumber = currentNumber;
                    this.filePattern = prefix + '###.html';
                    
                    // Vider le cache
                    this.fileCache = {};
                    
                    this.updateNavigation();
                    console.log(`[Navigation] Pattern custom d√©fini: ${this.filePattern}`);
                } catch (error) {
                    this.handleError('Erreur setCustomPattern', error);
                }
            },
            
            // ===== CACHE MANAGEMENT =====
            clearCache: function() {
                this.fileCache = {};
                console.log('[Navigation] Cache vid√©');
            }
        };

        // ===== INITIALISATION AUTOMATIQUE =====
        document.addEventListener('DOMContentLoaded', function() {
            Navigation.init();
            
            // Option: forcer un pattern sp√©cifique si n√©cessaire
            if (typeof window.navigationPattern !== 'undefined') {
                Navigation.setCustomPattern(
                    window.navigationPattern.prefix, 
                    window.navigationPattern.currentNumber
                );
            }
        });
        
        // ===== EXPOSITION GLOBALE (pour debug console) =====
        window.Navigation = Navigation;
    </script>
</body>
</html>
