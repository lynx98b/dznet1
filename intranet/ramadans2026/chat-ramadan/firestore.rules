rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ðŸ” Fonction helper : vÃ©rifie qu'un utilisateur est connectÃ©
    function isAuthenticated() {
      return request.auth != null;
    }

    // ðŸ” Fonction helper : vÃ©rifie que l'utilisateur modifie ses propres donnÃ©es
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // ðŸ” Fonction helper : vÃ©rifie qu'un message texte est valide
    function isValidTextMessage() {
      return request.resource.data.type == "text"
        && request.resource.data.content is string
        && request.resource.data.content.size() >= 1
        && request.resource.data.content.size() <= 200;
    }

    // ðŸŽ Fonction helper : vÃ©rifie qu'un cadeau est valide
    function isValidGift() {
      return request.resource.data.type == "gift"
        && request.resource.data.giftIcon is string
        && request.resource.data.giftLabel is string;
    }

    // ðŸ’¬ COLLECTION MESSAGES
    // - Lecture : tous les utilisateurs authentifiÃ©s
    // - CrÃ©ation : utilisateurs authentifiÃ©s uniquement (avec validation)
    // - Modification/Suppression : uniquement le crÃ©ateur du message
    match /messages/{messageId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.timestamp is timestamp
        && request.resource.data.username is string
        && (isValidTextMessage() || isValidGift());

      allow update, delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // ðŸ‘¥ COLLECTION USERS (PROFILS)
    // - Lecture : tous les utilisateurs authentifiÃ©s peuvent voir tous les profils
    // - CrÃ©ation/Modification : uniquement son propre profil
    match /users/{userId} {
      allow read: if isAuthenticated();

      allow create, update: if isOwner(userId)
        && request.resource.data.pseudo is string
        && request.resource.data.pseudo.size() >= 3
        && request.resource.data.pseudo.size() <= 20
        && request.resource.data.age is int
        && request.resource.data.age >= 13
        && request.resource.data.age <= 99
        && request.resource.data.gender in ['M', 'F'];

      allow delete: if isOwner(userId);
    }

    // âŒ¨ï¸ COLLECTION TYPING (INDICATEURS DE FRAPPE)
    // - Lecture/Ã‰criture : tous les utilisateurs authentifiÃ©s
    // - Les indicateurs de frappe sont temporaires et peu sensibles
    match /typing/{typingId} {
      allow read: if isAuthenticated();

      allow create, update: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated();
    }

    // ðŸ’ COLLECTION REACTIONS
    // - Lecture : tous les utilisateurs authentifiÃ©s
    // - CrÃ©ation : utilisateurs authentifiÃ©s (avec validation)
    // - Modification/Suppression : uniquement le crÃ©ateur
    match /reactions/{reactionId} {
      allow read: if isAuthenticated();

      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.messageId is string
        && request.resource.data.reaction is string;

      allow update, delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // ðŸš« Bloquer tout accÃ¨s non explicitement autorisÃ©
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
