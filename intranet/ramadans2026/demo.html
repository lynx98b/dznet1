<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadan Chat</title>
    
    <style>
        /* v1.009 - RETOUR VERSION STABLE */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #2C5F2D;
            --secondary: #D4AF37;
            --accent: #C1272D;
            --white: #FFFFFF;
        }
        
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f5f5f5;
        }
        
        /* ===== DISCLAIMER MODAL ===== */
        .disclaimer-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }
        
        .disclaimer-modal.show {
            display: flex;
        }
        
        .disclaimer-content {
            background: white;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .disclaimer-header {
            background: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            text-align: center;
        }
        
        .disclaimer-body {
            padding: 20px;
        }
        
        .disclaimer-body h3 {
            color: var(--primary);
            margin: 15px 0 10px;
        }
        
        .disclaimer-body ul {
            list-style: none;
            padding: 0;
        }
        
        .disclaimer-body li {
            padding: 8px;
            margin: 5px 0;
            background: #ffebee;
            border-left: 3px solid var(--accent);
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .disclaimer-body li::before {
            content: '‚ùå ';
        }
        
        .disclaimer-footer {
            padding: 20px;
            border-top: 1px solid #ddd;
        }
        
        .disclaimer-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .disclaimer-checkbox input {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .disclaimer-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
        }
        
        .disclaimer-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* ===== RATE LIMIT WARNING ===== */
        .rate-warning {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            display: none;
            z-index: 10000;
            font-weight: bold;
        }
        
        .rate-warning.show {
            display: block;
        }
        
        /* ===== CHAT WIDGET ===== */
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .chat-btn {
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            font-size: 0.7rem;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
        }
        
        /* ===== CHAT BOX ===== */
        .chat-box {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 400px;
            height: 550px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
        }
        
        .chat-box.show {
            display: flex;
        }
        
        /* Login */
        .chat-login {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 30px;
            text-align: center;
        }
        
        .chat-login h3 {
            color: var(--primary);
            margin: 20px 0;
        }
        
        .google-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 25px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .google-btn:hover {
            border-color: var(--primary);
        }
        
        /* Chat main */
        .chat-main {
            display: none;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-main.show {
            display: flex;
        }
        
        .chat-header {
            background: var(--primary);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 15px 15px 0 0;
        }
        
        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid var(--secondary);
        }
        
        .chat-close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #fafafa;
        }
        
        .message {
            margin-bottom: 15px;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }
        
        .message-avatar {
            width: 25px;
            height: 25px;
            border-radius: 50%;
        }
        
        .message-name {
            font-weight: bold;
            color: var(--primary);
            font-size: 0.85rem;
        }
        
        .message-time {
            font-size: 0.7rem;
            color: #999;
            margin-left: auto;
        }
        
        .message-content {
            background: white;
            padding: 10px 12px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            max-width: 80%;
        }
        
        .message.own .message-content {
            background: var(--primary);
            color: white;
            margin-left: auto;
        }
        
        .message.system {
            text-align: center;
        }
        
        .message.system .message-content {
            background: #fff3cd;
            color: #856404;
            display: inline-block;
            font-size: 0.85rem;
            padding: 6px 15px;
            border-radius: 15px;
        }
        
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #ddd;
        }
        
        .rate-counter {
            text-align: center;
            font-size: 0.8rem;
            color: var(--primary);
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .rate-counter.warning {
            color: orange;
        }
        
        .rate-counter.danger {
            color: var(--accent);
        }
        
        .chat-input-form {
            display: flex;
            gap: 8px;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        
        .chat-input:focus {
            border-color: var(--primary);
        }
        
        .chat-send {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .chat-send:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .chat-box {
                position: fixed;
                bottom: 0;
                right: 0;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                border-radius: 0;
                max-width: none;
            }
            
            .chat-header {
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    
    <!-- DISCLAIMER MODAL -->
    <div class="disclaimer-modal" id="disclaimerModal">
        <div class="disclaimer-content">
            <div class="disclaimer-header">
                <h2>üìú R√®gles du Chat</h2>
            </div>
            <div class="disclaimer-body">
                <h3>‚ùå Strictement Interdit</h3>
                <ul>
                    <li>Politique et propagande</li>
                    <li>Extr√©misme et haine</li>
                    <li>Armes et violence</li>
                    <li>Drogue</li>
                    <li>Menaces et intimidation</li>
                    <li>Discrimination</li>
                    <li>Contenu sexuel</li>
                    <li>Harc√®lement et insultes</li>
                    <li>Spam</li>
                    <li>D√©sinformation</li>
                </ul>
                <p style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 8px;">
                    <strong>‚è±Ô∏è Limite:</strong> 5 messages par minute maximum
                </p>
            </div>
            <div class="disclaimer-footer">
                <label class="disclaimer-checkbox">
                    <input type="checkbox" id="acceptCheckbox">
                    <span>J'ai lu et j'accepte les r√®gles</span>
                </label>
                <button class="disclaimer-btn" id="acceptBtn" disabled>Accepter</button>
            </div>
        </div>
    </div>
    
    <!-- RATE LIMIT WARNING -->
    <div class="rate-warning" id="rateWarning">
        ‚è±Ô∏è Trop de messages ! Patientez <span id="rateCountdown">10</span>s
    </div>
    
    <!-- CHAT WIDGET -->
    <div class="chat-widget">
        <button class="chat-btn" id="chatBtn">
            üí¨
            <span class="chat-badge" id="chatBadge">0</span>
        </button>
        
        <div class="chat-box" id="chatBox">
            <!-- Login -->
            <div class="chat-login" id="chatLogin">
                <div style="font-size: 4rem;">üåô</div>
                <h3>Chat Ramadan</h3>
                <p>Rejoignez la communaut√©</p>
                <button class="google-btn" id="googleBtn">
                    <span>üîê</span>
                    <span>Connexion Google</span>
                </button>
            </div>
            
            <!-- Chat -->
            <div class="chat-main" id="chatMain">
                <div class="chat-header">
                    <div class="chat-header-left">
                        <img src="" class="chat-avatar" id="userAvatar">
                        <div>
                            <div id="userName">Utilisateur</div>
                            <div style="font-size: 0.7rem;" id="onlineCount">En ligne</div>
                        </div>
                    </div>
                    <button class="chat-close-btn" id="closeBtn">‚úï</button>
                </div>
                
                <div class="chat-messages" id="messages"></div>
                
                <div class="chat-input-area">
                    <div class="rate-counter" id="rateCounter">5/5 messages</div>
                    <form class="chat-input-form" id="messageForm">
                        <input 
                            type="text" 
                            class="chat-input" 
                            id="messageInput" 
                            placeholder="Votre message..."
                            maxlength="200"
                            autocomplete="off"
                        >
                        <button type="submit" class="chat-send" id="sendBtn">üì§</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        console.log('üöÄ Chat v1.009 - Version stable');
        
        // ===== CONFIG FIREBASE =====
        const firebaseConfig = {
            apiKey: "AIzaSyBoF6xTWr4dzgbWFwXavVC2mMshHCTK6fM",
            authDomain: "ramadan-chat-auth.firebaseapp.com",
            projectId: "ramadan-chat-auth",
            storageBucket: "ramadan-chat-auth.firebasestorage.app",
            messagingSenderId: "785976346844",
            appId: "1:785976346844:web:62b890dbc32a32596f8c19"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const messagesRef = db.collection('messages');
        const usersRef = db.collection('users');
        const provider = new firebase.auth.GoogleAuthProvider();
        
        let currentUser = null;
        let unsubscribe = null;
        
        // DOM
        const chatBtn = document.getElementById('chatBtn');
        const chatBox = document.getElementById('chatBox');
        const chatLogin = document.getElementById('chatLogin');
        const chatMain = document.getElementById('chatMain');
        const googleBtn = document.getElementById('googleBtn');
        const closeBtn = document.getElementById('closeBtn');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const messages = document.getElementById('messages');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const onlineCount = document.getElementById('onlineCount');
        const rateCounter = document.getElementById('rateCounter');
        const rateWarning = document.getElementById('rateWarning');
        const rateCountdown = document.getElementById('rateCountdown');
        const disclaimerModal = document.getElementById('disclaimerModal');
        const acceptCheckbox = document.getElementById('acceptCheckbox');
        const acceptBtn = document.getElementById('acceptBtn');
        const chatBadge = document.getElementById('chatBadge');
        
        // ===== DISCLAIMER =====
        let termsAccepted = localStorage.getItem('terms') === 'ok';
        
        acceptCheckbox.addEventListener('change', () => {
            acceptBtn.disabled = !acceptCheckbox.checked;
        });
        
        acceptBtn.addEventListener('click', () => {
            localStorage.setItem('terms', 'ok');
            termsAccepted = true;
            disclaimerModal.classList.remove('show');
        });
        
        // ===== RATE LIMITING =====
        let messageTimes = [];
        const MAX_MESSAGES = 5;
        const TIME_WINDOW = 60000; // 1 minute
        const COOLDOWN = 10000; // 10 secondes
        let rateLimited = false;
        
        function checkRate() {
            const now = Date.now();
            messageTimes = messageTimes.filter(t => now - t < TIME_WINDOW);
            
            const remaining = MAX_MESSAGES - messageTimes.length;
            rateCounter.textContent = `${remaining}/${MAX_MESSAGES} messages`;
            rateCounter.className = 'rate-counter';
            
            if (remaining <= 1) rateCounter.classList.add('danger');
            else if (remaining <= 2) rateCounter.classList.add('warning');
            
            if (messageTimes.length >= MAX_MESSAGES) {
                activateRateLimit();
                return false;
            }
            return true;
        }
        
        function activateRateLimit() {
            if (rateLimited) return;
            rateLimited = true;
            rateWarning.classList.add('show');
            sendBtn.disabled = true;
            messageInput.disabled = true;
            
            let seconds = COOLDOWN / 1000;
            const interval = setInterval(() => {
                seconds--;
                rateCountdown.textContent = seconds;
                if (seconds <= 0) clearInterval(interval);
            }, 1000);
            
            setTimeout(() => {
                rateLimited = false;
                rateWarning.classList.remove('show');
                sendBtn.disabled = false;
                messageInput.disabled = false;
                messageTimes = [];
                checkRate();
            }, COOLDOWN);
        }
        
        // ===== UI =====
        chatBtn.addEventListener('click', () => {
            chatBox.classList.toggle('show');
        });
        
        closeBtn.addEventListener('click', () => {
            chatBox.classList.remove('show');
        });
        
        googleBtn.addEventListener('click', async () => {
            if (!termsAccepted) {
                disclaimerModal.classList.add('show');
                return;
            }
            
            try {
                await auth.signInWithPopup(provider);
                console.log('‚úÖ Connexion OK');
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                alert('Erreur: ' + error.message);
            }
        });
        
        // ===== AUTH =====
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log('‚úÖ User connect√©:', user.displayName);
                currentUser = user;
                
                chatLogin.style.display = 'none';
                chatMain.classList.add('show');
                userName.textContent = user.displayName;
                userAvatar.src = user.photoURL;
                
                // Ajouter user
                await usersRef.doc(user.uid).set({
                    name: user.displayName,
                    photo: user.photoURL,
                    time: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                usersRef.doc(user.uid).onDisconnect().delete();
                
                // Message syst√®me
                await messagesRef.add({
                    type: 'system',
                    text: `${user.displayName} a rejoint üåô`,
                    time: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                listenMessages();
                listenUsers();
                checkRate();
                
            } else {
                console.log('‚ùå User d√©connect√©');
                currentUser = null;
                chatLogin.style.display = 'flex';
                chatMain.classList.remove('show');
                messages.innerHTML = '';
                if (unsubscribe) unsubscribe();
            }
        });
        
        // ===== MESSAGES =====
        function listenMessages() {
            unsubscribe = messagesRef
                .orderBy('time', 'desc')
                .limit(50)
                .onSnapshot((snapshot) => {
                    messages.innerHTML = '';
                    const docs = [];
                    snapshot.forEach(doc => docs.push(doc.data()));
                    docs.reverse().forEach(msg => addMessage(msg));
                });
        }
        
        function addMessage(msg) {
            const div = document.createElement('div');
            const isOwn = currentUser && msg.uid === currentUser.uid;
            div.className = `message ${msg.type === 'system' ? 'system' : ''} ${isOwn ? 'own' : ''}`;
            
            if (msg.type === 'system') {
                div.innerHTML = `<div class="message-content">${msg.text}</div>`;
            } else {
                div.innerHTML = `
                    <div class="message-header">
                        <img src="${msg.photo}" class="message-avatar">
                        <span class="message-name">${msg.name}</span>
                        <span class="message-time">${formatTime(msg.time)}</span>
                    </div>
                    <div class="message-content">${msg.text}</div>
                `;
            }
            
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate();
            return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }
        
        // ===== SEND MESSAGE =====
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser || rateLimited) return;
            if (!checkRate()) return;
            
            const text = messageInput.value.trim();
            if (!text) return;
            
            try {
                await messagesRef.add({
                    uid: currentUser.uid,
                    name: currentUser.displayName,
                    photo: currentUser.photoURL,
                    text: text,
                    time: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                messageTimes.push(Date.now());
                messageInput.value = '';
                checkRate();
                
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                alert('Erreur envoi');
            }
        });
        
        // ===== USERS COUNT =====
        function listenUsers() {
            usersRef.onSnapshot((snapshot) => {
                onlineCount.textContent = `${snapshot.size} en ligne`;
            });
        }
        
        console.log('‚úÖ Chat pr√™t');
    </script>
    
</body>
</html>
