<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sidebar Users</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .login {
            text-align: center;
        }
        
        .google-btn {
            background: white;
            border: 2px solid #ddd;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .users-area {
            display: none;
        }
        
        .users-area.show {
            display: block;
        }
        
        .header {
            background: #2C5F2D;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #2C5F2D;
        }
        
        .logout-btn {
            background: #C1272D;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    
    <div class="container">
        <!-- √âcran connexion -->
        <div class="login" id="loginScreen">
            <h2>üß™ Test Sidebar Users</h2>
            <p>Connectez-vous pour voir la liste</p>
            <button class="google-btn" id="googleBtn">
                üîê Connexion Google
            </button>
        </div>
        
        <!-- Zone users -->
        <div class="users-area" id="usersArea">
            <div class="header">
                <h3>üë• Utilisateurs en ligne</h3>
                <div id="count">0 connect√©s</div>
            </div>
            
            <div id="usersList"></div>
            
            <button class="logout-btn" id="logoutBtn">D√©connexion</button>
        </div>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        console.log('üß™ TEST SIDEBAR USERS');
        
        // CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBoF6xTWr4dzgbWFwXavVC2mMshHCTK6fM",
            authDomain: "ramadan-chat-auth.firebaseapp.com",
            projectId: "ramadan-chat-auth",
            storageBucket: "ramadan-chat-auth.firebasestorage.app",
            messagingSenderId: "785976346844",
            appId: "1:785976346844:web:62b890dbc32a32596f8c19"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const usersRef = db.collection('users');
        const provider = new firebase.auth.GoogleAuthProvider();
        
        let currentUser = null;
        let unsubscribe = null;
        
        // DOM
        const loginScreen = document.getElementById('loginScreen');
        const usersArea = document.getElementById('usersArea');
        const googleBtn = document.getElementById('googleBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const usersList = document.getElementById('usersList');
        const count = document.getElementById('count');
        
        // CONNEXION
        googleBtn.addEventListener('click', async () => {
            try {
                await auth.signInWithPopup(provider);
                console.log('‚úÖ Connexion OK');
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                alert('Erreur: ' + error.message);
            }
        });
        
        // D√âCONNEXION
        logoutBtn.addEventListener('click', async () => {
            await auth.signOut();
        });
        
        // AUTH STATE
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log('‚úÖ User:', user.displayName);
                currentUser = user;
                
                loginScreen.style.display = 'none';
                usersArea.classList.add('show');
                
                // AJOUTER USER √Ä FIRESTORE
                try {
                    await usersRef.doc(user.uid).set({
                        uid: user.uid,
                        name: user.displayName,
                        photo: user.photoURL,
                        time: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚úÖ User ajout√© √† Firestore');
                    
                    // Supprimer √† la d√©connexion
                    usersRef.doc(user.uid).onDisconnect().delete();
                    
                    // √âCOUTER LES USERS
                    listenUsers();
                    
                } catch (error) {
                    console.error('‚ùå ERREUR FIRESTORE:', error);
                    alert('‚ùå ERREUR: ' + error.message + '\n\nV√©rifie les r√®gles Firestore !');
                }
                
            } else {
                console.log('‚ùå D√©connect√©');
                currentUser = null;
                loginScreen.style.display = 'block';
                usersArea.classList.remove('show');
                if (unsubscribe) unsubscribe();
                usersList.innerHTML = '';
            }
        });
        
        // √âCOUTER USERS
        function listenUsers() {
            console.log('üëÇ √âcoute des users...');
            
            unsubscribe = usersRef.onSnapshot((snapshot) => {
                console.log('üìä Snapshot re√ßu, nombre de docs:', snapshot.size);
                
                const users = [];
                snapshot.forEach((doc) => {
                    const user = doc.data();
                    console.log('üë§ User trouv√©:', user.name);
                    if (user.uid !== currentUser.uid) {
                        users.push(user);
                    }
                });
                
                // Mettre √† jour compteur
                count.textContent = `${users.length + 1} connect√©s`;
                
                // Vider liste
                usersList.innerHTML = '';
                
                // Afficher users
                users.forEach((user) => {
                    const div = document.createElement('div');
                    div.className = 'user-item';
                    div.innerHTML = `
                        <img src="${user.photo}" class="avatar">
                        <div>
                            <strong>${user.name}</strong>
                            <div style="font-size: 0.8rem; color: #666;">En ligne</div>
                        </div>
                    `;
                    usersList.appendChild(div);
                });
                
                console.log('‚úÖ Liste affich√©e:', users.length, 'users');
            }, (error) => {
                console.error('‚ùå ERREUR SNAPSHOT:', error);
                alert('‚ùå Erreur lecture users: ' + error.message);
            });
        }
        
        console.log('‚úÖ Script pr√™t');
    </script>
    
</body>
</html>
